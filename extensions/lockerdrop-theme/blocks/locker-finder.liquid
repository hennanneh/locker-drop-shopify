{% comment %}
  LockerDrop - Locker Finder Block with Interactive Map
  Find nearby locker locations
{% endcomment %}

{% style %}
  .lockerdrop-finder {
    padding: 40px 20px;
    background-color: #f8fafc;
  }

  .lockerdrop-finder__container {
    max-width: 1000px;
    margin: 0 auto;
  }

  .lockerdrop-finder__header {
    text-align: center;
    margin-bottom: 24px;
  }

  .lockerdrop-finder__title {
    font-size: 24px;
    font-weight: 700;
    color: #1e293b;
    margin: 0 0 8px;
  }

  .lockerdrop-finder__subtitle {
    font-size: 15px;
    color: #64748b;
    margin: 0;
  }

  .lockerdrop-finder__search {
    max-width: 450px;
    margin: 0 auto 24px;
  }

  .lockerdrop-finder__form {
    display: flex;
    gap: 10px;
  }

  .lockerdrop-finder__input {
    flex: 1;
    padding: 12px 16px;
    font-size: 15px;
    border: 2px solid #e2e8f0;
    border-radius: 8px;
    outline: none;
  }

  .lockerdrop-finder__input:focus {
    border-color: {{ block.settings.accent_color }};
  }

  .lockerdrop-finder__button {
    padding: 12px 20px;
    background: {{ block.settings.accent_color }};
    color: #ffffff;
    font-size: 14px;
    font-weight: 600;
    border: none;
    border-radius: 8px;
    cursor: pointer;
  }

  .lockerdrop-finder__button:hover {
    opacity: 0.9;
  }

  .lockerdrop-finder__content {
    display: none;
    gap: 20px;
    margin-top: 24px;
  }

  .lockerdrop-finder__content.active {
    display: flex;
  }

  .lockerdrop-finder__map {
    flex: 2;
    height: 400px;
    border-radius: 12px;
    border: 2px solid #e2e8f0;
    background: #f1f5f9;
  }

  .lockerdrop-finder__results {
    flex: 1;
    min-width: 280px;
    max-height: 400px;
    overflow-y: auto;
  }

  .lockerdrop-finder__loading {
    text-align: center;
    padding: 30px;
    color: #64748b;
  }

  .lockerdrop-finder__spinner {
    display: inline-block;
    width: 28px;
    height: 28px;
    border: 3px solid #e2e8f0;
    border-radius: 50%;
    border-top-color: {{ block.settings.accent_color }};
    animation: ld-spin 0.8s linear infinite;
    margin-bottom: 10px;
  }

  @keyframes ld-spin {
    to { transform: rotate(360deg); }
  }

  .lockerdrop-finder__empty {
    text-align: center;
    padding: 30px;
    background: #ffffff;
    border-radius: 10px;
    color: #64748b;
  }

  .lockerdrop-finder__location {
    background: #ffffff;
    border: 2px solid transparent;
    border-radius: 10px;
    padding: 14px;
    margin-bottom: 10px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .lockerdrop-finder__location:hover {
    border-color: {{ block.settings.accent_color }};
  }

  .lockerdrop-finder__location.active {
    border-color: {{ block.settings.accent_color }};
    background: #f0f4ff;
  }

  .lockerdrop-finder__loc-name {
    font-size: 15px;
    font-weight: 600;
    color: #1e293b;
    margin: 0 0 4px;
  }

  .lockerdrop-finder__loc-address {
    font-size: 13px;
    color: #64748b;
    margin: 0 0 2px;
  }

  .lockerdrop-finder__loc-distance {
    display: inline-block;
    margin-top: 6px;
    font-size: 13px;
    font-weight: 600;
    color: {{ block.settings.accent_color }};
  }

  @media (max-width: 768px) {
    .lockerdrop-finder__content {
      flex-direction: column;
    }
    .lockerdrop-finder__map {
      height: 300px;
      order: 2;
    }
    .lockerdrop-finder__results {
      order: 1;
      max-height: 250px;
    }
  }

  @media (max-width: 500px) {
    .lockerdrop-finder__form {
      flex-direction: column;
    }
  }
{% endstyle %}

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<div class="lockerdrop-finder">
  <div class="lockerdrop-finder__container">
    <div class="lockerdrop-finder__header">
      <h2 class="lockerdrop-finder__title">{{ block.settings.title }}</h2>
      <p class="lockerdrop-finder__subtitle">{{ block.settings.subtitle }}</p>
    </div>

    <div class="lockerdrop-finder__search">
      <form class="lockerdrop-finder__form" onsubmit="lockerdropSearch(event)">
        <input type="text" class="lockerdrop-finder__input" id="lockerdrop-zip" placeholder="Enter zip code" autocomplete="postal-code">
        <button type="submit" class="lockerdrop-finder__button">Find Lockers</button>
      </form>
    </div>

    <div class="lockerdrop-finder__content" id="lockerdrop-content">
      <div class="lockerdrop-finder__map" id="lockerdrop-map"></div>
      <div class="lockerdrop-finder__results" id="lockerdrop-results"></div>
    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  const LOCKERDROP_API = 'https://app.lockerdrop.it';
  let ldMap = null;
  let ldMarkers = [];
  let ldSearchLat = null;
  let ldSearchLon = null;
  let ldLocations = [];

  function initLdMap(lat, lon) {
    if (ldMap) {
      ldMap.setView([lat, lon], 11);
    } else {
      ldMap = L.map('lockerdrop-map').setView([lat, lon], 11);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap'
      }).addTo(ldMap);
    }
  }

  function clearLdMarkers() {
    ldMarkers.forEach(function(m) { ldMap.removeLayer(m); });
    ldMarkers = [];
  }

  function addLdMarkers(locations) {
    clearLdMarkers();

    var lockerIcon = L.divIcon({
      html: '<div style="background: {{ block.settings.accent_color }}; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 16px; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);">üì¶</div>',
      className: 'ld-marker',
      iconSize: [30, 30],
      iconAnchor: [15, 15]
    });

    var searchIcon = L.divIcon({
      html: '<div style="background: #e53935; color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);">üìç</div>',
      className: 'ld-search-marker',
      iconSize: [24, 24],
      iconAnchor: [12, 12]
    });

    var searchMarker = L.marker([ldSearchLat, ldSearchLon], { icon: searchIcon })
      .addTo(ldMap)
      .bindPopup('Your location');
    ldMarkers.push(searchMarker);

    locations.forEach(function(loc, i) {
      var marker = L.marker([loc.lat, loc.lon], { icon: lockerIcon })
        .addTo(ldMap)
        .bindPopup('<strong>' + loc.name + '</strong><br>' + loc.address + '<br>' + loc.city + ', ' + loc.state + ' ' + loc.zip + '<br><em>' + loc.distance.toFixed(1) + ' miles</em>');
      marker.on('click', function() { highlightLdCard(i); });
      ldMarkers.push(marker);
    });

    if (ldMarkers.length > 1) {
      var group = L.featureGroup(ldMarkers);
      ldMap.fitBounds(group.getBounds().pad(0.1));
    }
  }

  function highlightLdCard(index) {
    document.querySelectorAll('.lockerdrop-finder__location').forEach(function(card, i) {
      card.classList.toggle('active', i === index);
    });
    if (ldMarkers[index + 1]) {
      ldMarkers[index + 1].openPopup();
    }
  }

  function zoomToLocker(index) {
    highlightLdCard(index);
    var loc = ldLocations[index];
    if (loc && ldMap) {
      ldMap.setView([loc.lat, loc.lon], 14);
    }
  }

  async function lockerdropSearch(e) {
    e.preventDefault();
    var zip = document.getElementById('lockerdrop-zip').value.trim();
    if (!zip) return;

    document.getElementById('lockerdrop-content').classList.add('active');
    document.getElementById('lockerdrop-results').innerHTML = '<div class="lockerdrop-finder__loading"><div class="lockerdrop-finder__spinner"></div><p>Finding nearby lockers...</p></div>';

    try {
      var geoRes = await fetch('https://api.zippopotam.us/us/' + zip);
      if (!geoRes.ok) throw new Error('Invalid zip');
      var geoData = await geoRes.json();

      ldSearchLat = parseFloat(geoData.places[0].latitude);
      ldSearchLon = parseFloat(geoData.places[0].longitude);

      initLdMap(ldSearchLat, ldSearchLon);

      var res = await fetch(LOCKERDROP_API + '/api/public/lockers?lat=' + ldSearchLat + '&lon=' + ldSearchLon + '&limit=8');
      var data = await res.json();

      if (!data.locations || !data.locations.length) {
        document.getElementById('lockerdrop-results').innerHTML = '<div class="lockerdrop-finder__empty"><p>No locker locations found nearby</p></div>';
        return;
      }

      ldLocations = data.locations;
      addLdMarkers(ldLocations);

      var html = ldLocations.map(function(loc, i) {
        return '<div class="lockerdrop-finder__location" onclick="zoomToLocker(' + i + ')">' +
          '<h3 class="lockerdrop-finder__loc-name">' + loc.name + '</h3>' +
          '<p class="lockerdrop-finder__loc-address">' + loc.address + '</p>' +
          '<p class="lockerdrop-finder__loc-address">' + loc.city + ', ' + loc.state + ' ' + loc.zip + '</p>' +
          '<span class="lockerdrop-finder__loc-distance">' + loc.distance.toFixed(1) + ' miles</span>' +
          '</div>';
      }).join('');

      document.getElementById('lockerdrop-results').innerHTML = html;
    } catch (err) {
      document.getElementById('lockerdrop-results').innerHTML = '<div class="lockerdrop-finder__empty"><p>Could not find lockers for this zip code</p></div>';
    }
  }
</script>

{% schema %}
{
  "name": "LockerDrop Locker Finder",
  "target": "section",
  "settings": [
    {
      "type": "text",
      "id": "title",
      "label": "Title",
      "default": "Find a Locker Near You"
    },
    {
      "type": "text",
      "id": "subtitle",
      "label": "Subtitle",
      "default": "350+ locations across the US. Enter your zip code to find nearby lockers."
    },
    {
      "type": "color",
      "id": "accent_color",
      "label": "Accent color",
      "default": "#5c6ac4"
    }
  ]
}
{% endschema %}
