{% comment %}
  LockerDrop - How It Works Full Page
  Complete page section for explaining locker pickup with interactive map
{% endcomment %}

{% style %}
  .ld-page {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  }

  /* Hero Section */
  .ld-hero {
    text-align: center;
    padding: 60px 20px;
    background: linear-gradient(135deg, {{ block.settings.accent_color }} 0%, #4338ca 100%);
    color: #ffffff;
  }

  .ld-hero__icon {
    font-size: 48px;
    margin-bottom: 16px;
  }

  .ld-hero__title {
    font-size: 32px;
    font-weight: 700;
    margin: 0 0 12px;
  }

  .ld-hero__subtitle {
    font-size: 18px;
    opacity: 0.9;
    margin: 0;
    max-width: 500px;
    margin: 0 auto;
  }

  /* Steps Section */
  .ld-steps {
    padding: 60px 20px;
    background: #f8fafc;
  }

  .ld-steps__container {
    max-width: 900px;
    margin: 0 auto;
  }

  .ld-steps__header {
    text-align: center;
    margin-bottom: 40px;
  }

  .ld-steps__title {
    font-size: 24px;
    font-weight: 700;
    color: #1e293b;
    margin: 0 0 8px;
  }

  .ld-steps__grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 24px;
  }

  .ld-step {
    text-align: center;
    padding: 32px 20px;
    background: #ffffff;
    border-radius: 16px;
    border: 1px solid #e2e8f0;
    position: relative;
  }

  .ld-step__number {
    position: absolute;
    top: -14px;
    left: 50%;
    transform: translateX(-50%);
    width: 28px;
    height: 28px;
    background: {{ block.settings.accent_color }};
    color: #ffffff;
    font-size: 14px;
    font-weight: 700;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .ld-step__icon {
    font-size: 48px;
    margin-bottom: 16px;
  }

  .ld-step__title {
    font-size: 18px;
    font-weight: 600;
    color: #1e293b;
    margin: 0 0 8px;
  }

  .ld-step__desc {
    font-size: 14px;
    color: #64748b;
    margin: 0;
    line-height: 1.5;
  }

  /* Benefits Section */
  .ld-benefits {
    padding: 60px 20px;
    background: #ffffff;
  }

  .ld-benefits__container {
    max-width: 900px;
    margin: 0 auto;
  }

  .ld-benefits__header {
    text-align: center;
    margin-bottom: 40px;
  }

  .ld-benefits__title {
    font-size: 24px;
    font-weight: 700;
    color: #1e293b;
    margin: 0;
  }

  .ld-benefits__grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 20px;
  }

  .ld-benefit {
    display: flex;
    align-items: flex-start;
    gap: 16px;
    padding: 24px;
    background: #f8fafc;
    border-radius: 12px;
  }

  .ld-benefit__icon {
    flex-shrink: 0;
    width: 44px;
    height: 44px;
    background: {{ block.settings.accent_color }};
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 22px;
  }

  .ld-benefit__title {
    font-size: 16px;
    font-weight: 600;
    color: #1e293b;
    margin: 0 0 4px;
  }

  .ld-benefit__desc {
    font-size: 14px;
    color: #64748b;
    margin: 0;
    line-height: 1.4;
  }

  /* Finder Section */
  .ld-finder {
    padding: 60px 20px;
    background: #f8fafc;
  }

  .ld-finder__container {
    max-width: 1000px;
    margin: 0 auto;
    text-align: center;
  }

  .ld-finder__title {
    font-size: 24px;
    font-weight: 700;
    color: #1e293b;
    margin: 0 0 8px;
  }

  .ld-finder__subtitle {
    font-size: 15px;
    color: #64748b;
    margin: 0 0 24px;
  }

  .ld-finder__form {
    display: flex;
    gap: 10px;
    max-width: 450px;
    margin: 0 auto 24px;
  }

  .ld-finder__input {
    flex: 1;
    padding: 14px 18px;
    font-size: 16px;
    border: 2px solid #e2e8f0;
    border-radius: 10px;
    outline: none;
  }

  .ld-finder__input:focus {
    border-color: {{ block.settings.accent_color }};
  }

  .ld-finder__button {
    padding: 14px 24px;
    background: {{ block.settings.accent_color }};
    color: #ffffff;
    font-size: 15px;
    font-weight: 600;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    white-space: nowrap;
  }

  .ld-finder__button:hover {
    opacity: 0.9;
  }

  .ld-finder__content {
    display: none;
    gap: 20px;
    margin-top: 24px;
    text-align: left;
  }

  .ld-finder__content.active {
    display: flex;
  }

  .ld-finder__map {
    flex: 2;
    height: 400px;
    border-radius: 12px;
    border: 2px solid #e2e8f0;
    background: #f1f5f9;
  }

  .ld-finder__results {
    flex: 1;
    min-width: 280px;
    max-height: 400px;
    overflow-y: auto;
  }

  .ld-finder__loading {
    text-align: center;
    padding: 30px;
    color: #64748b;
  }

  .ld-finder__spinner {
    display: inline-block;
    width: 28px;
    height: 28px;
    border: 3px solid #e2e8f0;
    border-radius: 50%;
    border-top-color: {{ block.settings.accent_color }};
    animation: ld-spin 0.8s linear infinite;
  }

  @keyframes ld-spin {
    to { transform: rotate(360deg); }
  }

  .ld-finder__empty {
    text-align: center;
    padding: 24px;
    background: #ffffff;
    border-radius: 10px;
    color: #64748b;
  }

  .ld-finder__location {
    background: #ffffff;
    border: 2px solid transparent;
    border-radius: 10px;
    padding: 14px;
    margin-bottom: 10px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .ld-finder__location:hover {
    border-color: {{ block.settings.accent_color }};
  }

  .ld-finder__location.active {
    border-color: {{ block.settings.accent_color }};
    background: #f0f4ff;
  }

  .ld-finder__loc-name {
    font-size: 15px;
    font-weight: 600;
    color: #1e293b;
    margin: 0 0 4px;
  }

  .ld-finder__loc-address {
    font-size: 13px;
    color: #64748b;
    margin: 0 0 2px;
  }

  .ld-finder__loc-distance {
    display: inline-block;
    margin-top: 6px;
    font-size: 13px;
    font-weight: 600;
    color: {{ block.settings.accent_color }};
  }

  /* CTA Section */
  .ld-cta {
    padding: 60px 20px;
    background: #1e293b;
    text-align: center;
  }

  .ld-cta__title {
    font-size: 24px;
    font-weight: 700;
    color: #ffffff;
    margin: 0 0 12px;
  }

  .ld-cta__subtitle {
    font-size: 16px;
    color: #94a3b8;
    margin: 0 0 24px;
  }

  .ld-cta__button {
    display: inline-block;
    padding: 16px 32px;
    background: {{ block.settings.accent_color }};
    color: #ffffff;
    font-size: 16px;
    font-weight: 600;
    text-decoration: none;
    border-radius: 10px;
  }

  .ld-cta__button:hover {
    opacity: 0.9;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .ld-hero {
      padding: 40px 20px;
    }
    .ld-hero__title {
      font-size: 26px;
    }
    .ld-steps__grid {
      grid-template-columns: 1fr;
    }
    .ld-benefits__grid {
      grid-template-columns: 1fr;
    }
    .ld-finder__content {
      flex-direction: column;
    }
    .ld-finder__map {
      height: 300px;
      order: 2;
    }
    .ld-finder__results {
      order: 1;
      max-height: 250px;
    }
    .ld-finder__form {
      flex-direction: column;
    }
  }
{% endstyle %}

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<div class="ld-page">
  <!-- Hero -->
  <div class="ld-hero">
    <div class="ld-hero__icon">üì¶</div>
    <h1 class="ld-hero__title">{{ block.settings.hero_title }}</h1>
    <p class="ld-hero__subtitle">{{ block.settings.hero_subtitle }}</p>
  </div>

  <!-- Steps -->
  <div class="ld-steps">
    <div class="ld-steps__container">
      <div class="ld-steps__header">
        <h2 class="ld-steps__title">How It Works</h2>
      </div>
      <div class="ld-steps__grid">
        <div class="ld-step">
          <div class="ld-step__number">1</div>
          <div class="ld-step__icon">üõí</div>
          <h3 class="ld-step__title">Choose LockerDrop</h3>
          <p class="ld-step__desc">At checkout, select "LockerDrop" as your delivery method and pick a locker location near you.</p>
        </div>
        <div class="ld-step">
          <div class="ld-step__number">2</div>
          <div class="ld-step__icon">üì±</div>
          <h3 class="ld-step__title">Get Notified</h3>
          <p class="ld-step__desc">When your order is ready, you'll receive a text message and email with your unique pickup link.</p>
        </div>
        <div class="ld-step">
          <div class="ld-step__number">3</div>
          <div class="ld-step__icon">üîì</div>
          <h3 class="ld-step__title">Tap & Collect</h3>
          <p class="ld-step__desc">Visit the locker, tap your link, and the door opens automatically. Grab your package and go!</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Benefits -->
  <div class="ld-benefits">
    <div class="ld-benefits__container">
      <div class="ld-benefits__header">
        <h2 class="ld-benefits__title">Why Choose Locker Pickup?</h2>
      </div>
      <div class="ld-benefits__grid">
        <div class="ld-benefit">
          <div class="ld-benefit__icon">üïê</div>
          <div>
            <h3 class="ld-benefit__title">24/7 Access</h3>
            <p class="ld-benefit__desc">Pick up your order whenever it suits you, day or night. No waiting for delivery windows.</p>
          </div>
        </div>
        <div class="ld-benefit">
          <div class="ld-benefit__icon">üîí</div>
          <div>
            <h3 class="ld-benefit__title">Secure & Safe</h3>
            <p class="ld-benefit__desc">Your package stays protected in a locked compartment until you're ready to collect it.</p>
          </div>
        </div>
        <div class="ld-benefit">
          <div class="ld-benefit__icon">‚ö°</div>
          <div>
            <h3 class="ld-benefit__title">Quick & Easy</h3>
            <p class="ld-benefit__desc">No lines, no signatures. Just tap your link and the locker opens instantly.</p>
          </div>
        </div>
        <div class="ld-benefit">
          <div class="ld-benefit__icon">üìç</div>
          <div>
            <h3 class="ld-benefit__title">Convenient Locations</h3>
            <p class="ld-benefit__desc">Find lockers in convenient spots near work, home, or your daily commute.</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Locker Finder with Map -->
  <div class="ld-finder">
    <div class="ld-finder__container">
      <h2 class="ld-finder__title">Find a Locker Near You</h2>
      <p class="ld-finder__subtitle">350+ locations across the US. Enter your zip code to find nearby lockers.</p>
      <form class="ld-finder__form" onsubmit="ldPageSearch(event)">
        <input type="text" class="ld-finder__input" id="ld-page-zip" placeholder="Enter zip code" autocomplete="postal-code">
        <button type="submit" class="ld-finder__button">Search</button>
      </form>
      <div class="ld-finder__content" id="ld-page-content">
        <div class="ld-finder__map" id="ld-page-map"></div>
        <div class="ld-finder__results" id="ld-page-results"></div>
      </div>
    </div>
  </div>

  <!-- CTA -->
  <div class="ld-cta">
    <h2 class="ld-cta__title">Ready to Try Locker Pickup?</h2>
    <p class="ld-cta__subtitle">Select LockerDrop at checkout on your next order</p>
    <a href="{{ block.settings.cta_url | default: '/collections/all' }}" class="ld-cta__button">{{ block.settings.cta_text }}</a>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  const LD_PAGE_API = 'https://app.lockerdrop.it';
  let ldPageMap = null;
  let ldPageMarkers = [];
  let ldPageSearchLat = null;
  let ldPageSearchLon = null;
  let ldPageLocations = [];

  function initLdPageMap(lat, lon) {
    if (ldPageMap) {
      ldPageMap.setView([lat, lon], 11);
    } else {
      ldPageMap = L.map('ld-page-map').setView([lat, lon], 11);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap'
      }).addTo(ldPageMap);
    }
  }

  function clearLdPageMarkers() {
    ldPageMarkers.forEach(function(m) { ldPageMap.removeLayer(m); });
    ldPageMarkers = [];
  }

  function addLdPageMarkers(locations) {
    clearLdPageMarkers();

    var lockerIcon = L.divIcon({
      html: '<div style="background: {{ block.settings.accent_color }}; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 16px; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);">üì¶</div>',
      className: 'ld-page-marker',
      iconSize: [30, 30],
      iconAnchor: [15, 15]
    });

    var searchIcon = L.divIcon({
      html: '<div style="background: #e53935; color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);">üìç</div>',
      className: 'ld-page-search-marker',
      iconSize: [24, 24],
      iconAnchor: [12, 12]
    });

    var searchMarker = L.marker([ldPageSearchLat, ldPageSearchLon], { icon: searchIcon })
      .addTo(ldPageMap)
      .bindPopup('Your location');
    ldPageMarkers.push(searchMarker);

    locations.forEach(function(loc, i) {
      var marker = L.marker([loc.lat, loc.lon], { icon: lockerIcon })
        .addTo(ldPageMap)
        .bindPopup('<strong>' + loc.name + '</strong><br>' + loc.address + '<br>' + loc.city + ', ' + loc.state + ' ' + loc.zip + '<br><em>' + loc.distance.toFixed(1) + ' miles</em>');
      marker.on('click', function() { highlightLdPageCard(i); });
      ldPageMarkers.push(marker);
    });

    if (ldPageMarkers.length > 1) {
      var group = L.featureGroup(ldPageMarkers);
      ldPageMap.fitBounds(group.getBounds().pad(0.1));
    }
  }

  function highlightLdPageCard(index) {
    document.querySelectorAll('.ld-finder__location').forEach(function(card, i) {
      card.classList.toggle('active', i === index);
    });
    if (ldPageMarkers[index + 1]) {
      ldPageMarkers[index + 1].openPopup();
    }
  }

  function zoomToLdPageLocker(index) {
    highlightLdPageCard(index);
    var loc = ldPageLocations[index];
    if (loc && ldPageMap) {
      ldPageMap.setView([loc.lat, loc.lon], 14);
    }
  }

  async function ldPageSearch(e) {
    e.preventDefault();
    var zip = document.getElementById('ld-page-zip').value.trim();
    if (!zip) return;

    document.getElementById('ld-page-content').classList.add('active');
    document.getElementById('ld-page-results').innerHTML = '<div class="ld-finder__loading"><div class="ld-finder__spinner"></div><p>Finding nearby lockers...</p></div>';

    try {
      var geoRes = await fetch('https://api.zippopotam.us/us/' + zip);
      if (!geoRes.ok) throw new Error('Invalid zip');
      var geoData = await geoRes.json();

      ldPageSearchLat = parseFloat(geoData.places[0].latitude);
      ldPageSearchLon = parseFloat(geoData.places[0].longitude);

      initLdPageMap(ldPageSearchLat, ldPageSearchLon);

      var res = await fetch(LD_PAGE_API + '/api/public/lockers?lat=' + ldPageSearchLat + '&lon=' + ldPageSearchLon + '&limit=8');
      var data = await res.json();

      if (!data.locations || !data.locations.length) {
        document.getElementById('ld-page-results').innerHTML = '<div class="ld-finder__empty"><p>No locker locations found nearby</p></div>';
        return;
      }

      ldPageLocations = data.locations;
      addLdPageMarkers(ldPageLocations);

      var html = ldPageLocations.map(function(loc, i) {
        return '<div class="ld-finder__location" onclick="zoomToLdPageLocker(' + i + ')">' +
          '<h3 class="ld-finder__loc-name">' + loc.name + '</h3>' +
          '<p class="ld-finder__loc-address">' + loc.address + '</p>' +
          '<p class="ld-finder__loc-address">' + loc.city + ', ' + loc.state + ' ' + loc.zip + '</p>' +
          '<span class="ld-finder__loc-distance">' + loc.distance.toFixed(1) + ' miles</span>' +
          '</div>';
      }).join('');

      document.getElementById('ld-page-results').innerHTML = html;
    } catch (err) {
      document.getElementById('ld-page-results').innerHTML = '<div class="ld-finder__empty"><p>Could not find lockers for this zip code</p></div>';
    }
  }
</script>

{% schema %}
{
  "name": "LockerDrop Info Page",
  "target": "section",
  "settings": [
    {
      "type": "text",
      "id": "hero_title",
      "label": "Hero title",
      "default": "LockerDrop Pickup"
    },
    {
      "type": "text",
      "id": "hero_subtitle",
      "label": "Hero subtitle",
      "default": "Skip the delivery wait. Pick up from a secure locker anytime."
    },
    {
      "type": "url",
      "id": "cta_url",
      "label": "Button URL"
    },
    {
      "type": "text",
      "id": "cta_text",
      "label": "Button text",
      "default": "Start Shopping"
    },
    {
      "type": "color",
      "id": "accent_color",
      "label": "Accent color",
      "default": "#5c6ac4"
    }
  ]
}
{% endschema %}
