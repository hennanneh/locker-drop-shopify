<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LockerDrop - Dashboard</title>
    <!-- Polaris Design Tokens -->
    <style>
        :root {
            /* Colors - Polaris tokens */
            --p-color-bg: #f1f1f1;
            --p-color-bg-surface: #ffffff;
            --p-color-bg-surface-secondary: #f6f6f7;
            --p-color-bg-surface-hover: #f1f1f1;
            --p-color-bg-fill-brand: #008060;
            --p-color-bg-fill-brand-hover: #006e52;
            --p-color-bg-fill-brand-selected: #004c3f;
            --p-color-bg-fill-success: #aee9d1;
            --p-color-bg-fill-warning: #ffea8a;
            --p-color-bg-fill-critical: #fed3d1;
            --p-color-bg-fill-info: #a4e8f2;

            --p-color-text: #202223;
            --p-color-text-secondary: #6d7175;
            --p-color-text-success: #008060;
            --p-color-text-warning: #8a6116;
            --p-color-text-critical: #d72c0d;

            --p-color-border: #8c9196;
            --p-color-border-secondary: #e1e3e5;
            --p-color-border-tertiary: #c9cccf;

            --p-color-icon: #5c5f62;
            --p-color-icon-brand: #008060;

            /* Spacing - 4px base */
            --p-space-0: 0;
            --p-space-050: 2px;
            --p-space-100: 4px;
            --p-space-150: 6px;
            --p-space-200: 8px;
            --p-space-300: 12px;
            --p-space-400: 16px;
            --p-space-500: 20px;
            --p-space-600: 24px;
            --p-space-800: 32px;
            --p-space-1000: 40px;

            /* Border Radius */
            --p-border-radius-100: 4px;
            --p-border-radius-200: 8px;
            --p-border-radius-300: 12px;
            --p-border-radius-full: 9999px;

            /* Shadows */
            --p-shadow-100: 0 1px 0 rgba(0, 0, 0, 0.05);
            --p-shadow-200: 0 1px 2px rgba(0, 0, 0, 0.15);
            --p-shadow-300: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --p-shadow-bevel: 1px 0 0 0 rgba(0, 0, 0, 0.13) inset, -1px 0 0 0 rgba(0, 0, 0, 0.13) inset, 0 1px 0 0 rgba(0, 0, 0, 0.17) inset, 0 -1px 0 0 rgba(0, 0, 0, 0.09) inset;
            --p-shadow-card: 0 0 0 1px rgba(63, 63, 68, 0.05), 0 1px 3px 0 rgba(63, 63, 68, 0.15);

            /* Typography */
            --p-font-family: -apple-system, BlinkMacSystemFont, 'San Francisco', 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
            --p-font-size-75: 12px;
            --p-font-size-100: 13px;
            --p-font-size-200: 14px;
            --p-font-size-300: 15px;
            --p-font-size-400: 16px;
            --p-font-size-500: 20px;
            --p-font-size-600: 24px;
            --p-font-weight-regular: 400;
            --p-font-weight-medium: 500;
            --p-font-weight-semibold: 600;
            --p-font-weight-bold: 700;
            --p-line-height-200: 20px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--p-font-family);
            font-size: var(--p-font-size-200);
            line-height: var(--p-line-height-200);
            background: var(--p-color-bg);
            color: var(--p-color-text);
            -webkit-font-smoothing: antialiased;
        }

        /* === FRAME / LAYOUT === */
        .header {
            background: var(--p-color-bg-surface);
            border-bottom: 1px solid var(--p-color-border-secondary);
            padding: var(--p-space-400) var(--p-space-600);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: var(--p-font-size-500);
            font-weight: var(--p-font-weight-semibold);
            color: var(--p-color-text-success);
            display: flex;
            align-items: center;
            gap: var(--p-space-200);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: var(--p-space-300);
            color: var(--p-color-text-secondary);
            font-size: var(--p-font-size-100);
        }

        .container {
            max-width: 1040px;
            margin: 0 auto;
            padding: var(--p-space-600);
        }

        /* === TABS (Polaris-style) === */
        .nav-tabs {
            display: flex;
            gap: var(--p-space-100);
            margin-bottom: var(--p-space-500);
            border-bottom: 1px solid var(--p-color-border-secondary);
            padding-bottom: 0;
            background: transparent;
            box-shadow: none;
        }

        .tab {
            position: relative;
            padding: var(--p-space-300) var(--p-space-400);
            border: none;
            background: transparent;
            border-radius: 0;
            cursor: pointer;
            font-size: var(--p-font-size-200);
            font-weight: var(--p-font-weight-medium);
            color: var(--p-color-text-secondary);
            transition: color 0.15s ease;
        }

        .tab:hover {
            color: var(--p-color-text);
            background: transparent;
        }

        .tab.active {
            color: var(--p-color-text);
            background: transparent;
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--p-color-bg-fill-brand);
            border-radius: 3px 3px 0 0;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* === CARD (Polaris LegacyCard) === */
        .card {
            background: var(--p-color-bg-surface);
            border-radius: var(--p-border-radius-200);
            box-shadow: var(--p-shadow-card);
            margin-bottom: var(--p-space-500);
            overflow: hidden;
        }

        .card > *:first-child {
            padding: var(--p-space-500);
        }

        .card > *:not(:first-child) {
            padding: 0 var(--p-space-500) var(--p-space-500);
        }

        .card-header {
            font-size: var(--p-font-size-400);
            font-weight: var(--p-font-weight-semibold);
            color: var(--p-color-text);
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .card-header-title {
            display: flex;
            align-items: center;
            gap: var(--p-space-200);
        }

        .card-header-title svg {
            color: var(--p-color-icon-brand);
        }

        .card-description {
            color: var(--p-color-text-secondary);
            font-size: var(--p-font-size-200);
            margin-top: var(--p-space-100);
            line-height: 1.5;
        }

        .section-divider {
            border-top: 1px solid var(--p-color-border-secondary);
            margin: var(--p-space-500) 0;
            padding-top: var(--p-space-500);
        }

        /* === BANNER / CALLOUT (Polaris Banner) === */
        .info-box {
            padding: var(--p-space-400);
            background: var(--p-color-bg-surface-secondary);
            border-radius: var(--p-border-radius-200);
            font-size: var(--p-font-size-200);
        }

        .info-box.tip {
            background: #fff5ea;
            border: 1px solid #ffcc81;
        }

        .info-box.success {
            background: #f0fdf4;
            border: 1px solid var(--p-color-bg-fill-success);
        }

        .info-box.critical {
            background: #fff4f4;
            border: 1px solid #fed3d1;
        }

        .info-box strong {
            color: var(--p-color-text);
            font-weight: var(--p-font-weight-medium);
        }

        /* === FORM ELEMENTS (Polaris TextField) === */
        .form-group {
            margin-bottom: var(--p-space-400);
        }

        .form-label {
            display: block;
            font-size: var(--p-font-size-200);
            font-weight: var(--p-font-weight-medium);
            margin-bottom: var(--p-space-100);
            color: var(--p-color-text);
        }

        .form-help {
            color: var(--p-color-text-secondary);
            font-size: var(--p-font-size-100);
            margin-top: var(--p-space-100);
        }

        .form-input {
            width: 100%;
            padding: var(--p-space-200) var(--p-space-300);
            font-size: var(--p-font-size-200);
            font-family: inherit;
            border: 1px solid var(--p-color-border-tertiary);
            border-radius: var(--p-border-radius-200);
            background: var(--p-color-bg-surface);
            transition: border-color 0.15s ease, box-shadow 0.15s ease;
        }

        .form-input:hover {
            border-color: var(--p-color-border);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--p-color-bg-fill-brand);
            box-shadow: 0 0 0 1px var(--p-color-bg-fill-brand);
        }

        .two-column-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--p-space-500);
        }

        @media (max-width: 768px) {
            .two-column-grid {
                grid-template-columns: 1fr;
            }
        }

        /* === BUTTON (Polaris Button) === */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--p-space-100);
            min-height: 36px;
            padding: var(--p-space-150) var(--p-space-400);
            font-family: inherit;
            font-size: var(--p-font-size-200);
            font-weight: var(--p-font-weight-medium);
            line-height: 1;
            border-radius: var(--p-border-radius-200);
            cursor: pointer;
            transition: background 0.15s ease, border-color 0.15s ease;
            text-decoration: none;
            border: none;
        }

        .btn-primary {
            background: var(--p-color-bg-fill-brand);
            color: white;
            box-shadow: var(--p-shadow-bevel), var(--p-shadow-100);
        }

        .btn-primary:hover {
            background: var(--p-color-bg-fill-brand-hover);
        }

        .btn-primary:active {
            background: var(--p-color-bg-fill-brand-selected);
        }

        .btn-secondary {
            background: var(--p-color-bg-surface);
            color: var(--p-color-text);
            border: 1px solid var(--p-color-border-tertiary);
            box-shadow: var(--p-shadow-100);
        }

        .btn-secondary:hover {
            background: var(--p-color-bg-surface-hover);
        }

        .btn-small {
            min-height: 28px;
            padding: var(--p-space-100) var(--p-space-300);
            font-size: var(--p-font-size-100);
        }

        /* === DATA TABLE (Polaris DataTable) === */
        .orders-table {
            width: 100%;
            border-collapse: collapse;
        }

        .orders-table th {
            text-align: left;
            padding: var(--p-space-300) var(--p-space-400);
            background: var(--p-color-bg-surface-secondary);
            font-size: var(--p-font-size-100);
            font-weight: var(--p-font-weight-medium);
            color: var(--p-color-text-secondary);
            border-bottom: 1px solid var(--p-color-border-secondary);
        }

        .orders-table th.sortable {
            cursor: pointer;
            user-select: none;
            position: relative;
            padding-right: 24px;
        }

        .orders-table th.sortable:hover {
            background: var(--p-color-bg-surface-hover);
            color: var(--p-color-text);
        }

        .orders-table th.sortable::after {
            content: '‚áÖ';
            position: absolute;
            right: 8px;
            opacity: 0.3;
            font-size: 11px;
        }

        .orders-table th.sortable.sort-asc::after {
            content: '‚Üë';
            opacity: 0.8;
        }

        .orders-table th.sortable.sort-desc::after {
            content: '‚Üì';
            opacity: 0.8;
        }

        .orders-table td {
            padding: var(--p-space-300) var(--p-space-400);
            border-bottom: 1px solid var(--p-color-border-secondary);
            font-size: var(--p-font-size-200);
            vertical-align: middle;
        }

        .orders-table tr:hover td {
            background: var(--p-color-bg-surface-hover);
        }

        /* === BADGE (Polaris Badge) === */
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: var(--p-space-050) var(--p-space-200);
            border-radius: var(--p-border-radius-full);
            font-size: var(--p-font-size-75);
            font-weight: var(--p-font-weight-medium);
            white-space: nowrap;
        }

        .status-pending_dropoff {
            background: var(--p-color-bg-fill-warning);
            color: var(--p-color-text-warning);
        }

        .status-ready_for_pickup {
            background: var(--p-color-bg-fill-success);
            color: var(--p-color-text-success);
        }

        .status-completed {
            background: var(--p-color-bg-surface-secondary);
            color: var(--p-color-text-secondary);
        }

        .status-cancelled {
            background: var(--p-color-bg-fill-critical);
            color: var(--p-color-text-critical);
        }

        /* === FILTER BUTTONS (Polaris SegmentedControl style) === */
        .filter-btn {
            padding: var(--p-space-150) var(--p-space-300);
            border: 1px solid var(--p-color-border-secondary);
            background: var(--p-color-bg-surface);
            border-radius: var(--p-border-radius-full);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            color: #6d7175;
        }

        .filter-btn:hover {
            border-color: var(--p-color-bg-fill-brand);
            color: var(--p-color-bg-fill-brand);
        }

        .filter-btn.active {
            background: var(--p-color-bg-fill-brand);
            color: white;
            border-color: var(--p-color-bg-fill-brand);
        }

        /* === RESOURCE LIST / LOCKER SELECTOR === */
        .locker-selector {
            display: flex;
            flex-direction: column;
            gap: 0;
            border: 1px solid var(--p-color-border-secondary);
            border-radius: var(--p-border-radius-200);
            overflow: hidden;
        }

        .locker-item {
            display: flex;
            align-items: center;
            gap: var(--p-space-300);
            padding: var(--p-space-300) var(--p-space-400);
            cursor: pointer;
            transition: background 0.1s ease;
            background: var(--p-color-bg-surface);
            border-bottom: 1px solid var(--p-color-border-secondary);
        }

        .locker-item:last-child {
            border-bottom: none;
        }

        .locker-item:hover {
            background: var(--p-color-bg-surface-hover);
        }

        .locker-item.selected {
            background: #f0fdf4;
        }

        .locker-checkbox {
            width: 18px;
            height: 18px;
            border: 2px solid var(--p-color-border);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.1s ease;
        }

        .locker-item.selected .locker-checkbox {
            background: var(--p-color-bg-fill-brand);
            border-color: var(--p-color-bg-fill-brand);
        }

        .locker-checkbox svg {
            display: none;
        }

        .locker-item.selected .locker-checkbox svg {
            display: block;
        }

        .locker-info {
            flex: 1;
            min-width: 0;
        }

        .locker-name {
            font-weight: var(--p-font-weight-medium);
            color: var(--p-color-text);
            font-size: var(--p-font-size-200);
        }

        .locker-address {
            font-size: var(--p-font-size-100);
            color: var(--p-color-text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .locker-sizes {
            display: flex;
            gap: var(--p-space-100);
            flex-shrink: 0;
        }

        .size-badge {
            padding: 2px 6px;
            background: var(--p-color-bg-surface-secondary);
            border-radius: var(--p-border-radius-100);
            font-size: 11px;
            color: var(--p-color-text-secondary);
        }

        /* === MODAL (Polaris Modal) === */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(2px);
        }

        .modal-content {
            background: var(--p-color-bg-surface);
            margin: 5% auto;
            border-radius: var(--p-border-radius-300);
            width: 90%;
            max-width: 620px;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: 0 26px 80px rgba(0, 0, 0, 0.2), 0 0 1px rgba(0, 0, 0, 0.2);
        }

        .modal-content > * {
            padding: var(--p-space-500);
        }

        .close {
            float: right;
            font-size: 24px;
            font-weight: normal;
            cursor: pointer;
            color: var(--p-color-icon);
            line-height: 1;
        }

        .close:hover {
            color: var(--p-color-text);
        }

        .order-details {
            background: var(--p-color-bg-surface-secondary);
            padding: var(--p-space-400);
            border-radius: var(--p-border-radius-200);
            margin-top: var(--p-space-300);
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: var(--p-space-200) 0;
            border-bottom: 1px solid var(--p-color-border-secondary);
        }

        .detail-row:last-child {
            border-bottom: none;
        }

        .detail-label {
            font-weight: var(--p-font-weight-medium);
            color: var(--p-color-text-secondary);
        }

        .action-buttons {
            display: flex;
            gap: var(--p-space-200);
            flex-wrap: wrap;
        }

        /* === EMPTY STATE === */
        .empty-state {
            text-align: center;
            padding: var(--p-space-1000) var(--p-space-500);
            color: var(--p-color-text-secondary);
        }

        /* === COLLAPSIBLE SECTIONS === */
        .collapsible-header {
            cursor: pointer;
            user-select: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .collapsible-header:hover {
            opacity: 0.85;
        }

        .collapse-icon {
            transition: transform 0.2s ease;
            color: var(--p-color-icon);
        }

        .collapsible-header.collapsed .collapse-icon {
            transform: rotate(-90deg);
        }

        .collapsible-content {
            max-height: 2000px;
            overflow: hidden;
            transition: max-height 0.3s ease-out, opacity 0.2s ease;
            opacity: 1;
        }

        .collapsible-content.collapsed {
            max-height: 0;
            opacity: 0;
        }

        .empty-state h3 {
            margin-bottom: var(--p-space-200);
            color: var(--p-color-text);
            font-weight: var(--p-font-weight-semibold);
        }

        /* === STATS GRID === */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: var(--p-space-400);
            margin-bottom: var(--p-space-500);
        }

        .stat-card {
            background: var(--p-color-bg-surface);
            padding: var(--p-space-400);
            border-radius: var(--p-border-radius-200);
            box-shadow: var(--p-shadow-card);
        }

        .stat-label {
            color: var(--p-color-text-secondary);
            font-size: var(--p-font-size-100);
            margin-bottom: var(--p-space-100);
        }

        .stat-value {
            font-size: var(--p-font-size-600);
            font-weight: var(--p-font-weight-semibold);
            color: var(--p-color-text);
        }

        .stat-card-clickable {
            cursor: pointer;
            transition: transform 0.15s ease, box-shadow 0.15s ease;
        }

        .stat-card-clickable:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .stat-card-clickable:active {
            transform: translateY(0);
        }

        .stat-subtext {
            font-size: 12px;
            color: var(--p-color-text-secondary);
            margin-top: 4px;
            min-height: 18px;
        }

        .stat-subtext.success {
            color: var(--p-color-text-success);
        }

        .stat-subtext.warning {
            color: var(--p-color-text-warning);
        }

        .stat-action-btn {
            display: inline-block;
            margin-top: 8px;
            padding: 4px 0;
            font-size: 12px;
            color: var(--p-color-text-link);
            background: none;
            border: none;
            cursor: pointer;
            text-decoration: none;
            transition: color 0.15s ease;
        }

        .stat-action-btn:hover {
            color: var(--p-color-text-link-hover);
            text-decoration: underline;
        }

        /* Priority Action Banner */
        .priority-banner {
            background: linear-gradient(135deg, #fef3cd 0%, #fff8e1 100%);
            border: 1px solid #f0c36d;
            border-radius: var(--p-border-radius-200);
            padding: 12px 16px;
            margin-bottom: var(--p-space-400);
        }

        .priority-content {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .priority-icon {
            font-size: 24px;
        }

        .priority-text {
            flex: 1;
            min-width: 200px;
            font-size: 14px;
            color: #856404;
        }

        .priority-actions {
            display: flex;
            gap: 8px;
        }

        /* === BUTTON LOADING STATE === */
        .btn-loading {
            position: relative;
            color: transparent !important;
            pointer-events: none;
        }

        .btn-loading::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            top: 50%;
            left: 50%;
            margin-left: -8px;
            margin-top: -8px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: btn-spin 0.6s linear infinite;
        }

        .btn-secondary.btn-loading::after {
            border-color: rgba(0, 0, 0, 0.2);
            border-top-color: #5c6ac4;
        }

        @keyframes btn-spin {
            to { transform: rotate(360deg); }
        }

        /* === ONBOARDING WIZARD === */
        .onboarding-modal .modal-content {
            max-width: 560px;
            padding: 0;
        }

        .onboarding-header {
            background: linear-gradient(135deg, #008060 0%, #004c3f 100%);
            color: white;
            padding: var(--p-space-600);
            text-align: center;
        }

        .onboarding-header h2 {
            font-size: var(--p-font-size-500);
            margin-bottom: var(--p-space-200);
        }

        .onboarding-header p {
            opacity: 0.9;
            font-size: var(--p-font-size-200);
        }

        .onboarding-progress {
            display: flex;
            justify-content: center;
            gap: var(--p-space-200);
            padding: var(--p-space-400) var(--p-space-600);
            background: var(--p-color-bg-surface-secondary);
        }

        .progress-step {
            display: flex;
            align-items: center;
            gap: var(--p-space-200);
            font-size: var(--p-font-size-100);
            color: var(--p-color-text-secondary);
        }

        .progress-step.active {
            color: var(--p-color-text-success);
            font-weight: var(--p-font-weight-medium);
        }

        .progress-step.completed {
            color: var(--p-color-text-success);
        }

        .step-number {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: var(--p-font-weight-semibold);
            background: var(--p-color-border-secondary);
            color: var(--p-color-text-secondary);
        }

        .progress-step.active .step-number {
            background: var(--p-color-bg-fill-brand);
            color: white;
        }

        .progress-step.completed .step-number {
            background: var(--p-color-bg-fill-brand);
            color: white;
        }

        .onboarding-body {
            padding: var(--p-space-600);
        }

        .onboarding-step {
            display: none;
        }

        .onboarding-step.active {
            display: block;
        }

        .onboarding-step h3 {
            font-size: var(--p-font-size-400);
            margin-bottom: var(--p-space-200);
            color: var(--p-color-text);
        }

        .onboarding-step p {
            color: var(--p-color-text-secondary);
            margin-bottom: var(--p-space-400);
            font-size: var(--p-font-size-200);
        }

        .onboarding-tip {
            background: #f0fdf4;
            border-left: 3px solid var(--p-color-bg-fill-brand);
            padding: var(--p-space-300) var(--p-space-400);
            border-radius: 0 var(--p-border-radius-100) var(--p-border-radius-100) 0;
            margin-bottom: var(--p-space-400);
            font-size: var(--p-font-size-100);
            color: #065f46;
        }

        .onboarding-footer {
            padding: var(--p-space-400) var(--p-space-600);
            border-top: 1px solid var(--p-color-border-secondary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .skip-link {
            color: var(--p-color-text-secondary);
            font-size: var(--p-font-size-100);
            text-decoration: underline;
            cursor: pointer;
        }

        .skip-link:hover {
            color: var(--p-color-text);
        }

        .onboarding-actions {
            display: flex;
            gap: var(--p-space-200);
        }

        /* === SKELETON LOADING === */
        .skeleton {
            background: linear-gradient(90deg, #e1e3e5 25%, #f0f0f0 50%, #e1e3e5 75%);
            background-size: 200% 100%;
            animation: skeleton-shimmer 1.5s infinite;
            border-radius: var(--p-border-radius-100);
        }

        @keyframes skeleton-shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .skeleton-text {
            height: 14px;
            margin-bottom: 8px;
        }

        .skeleton-text.short { width: 60%; }
        .skeleton-text.medium { width: 80%; }
        .skeleton-text.long { width: 100%; }

        .skeleton-stat {
            height: 32px;
            width: 60px;
            margin-bottom: 4px;
        }

        .skeleton-row {
            display: flex;
            gap: 16px;
            padding: 12px 0;
            border-bottom: 1px solid var(--p-color-border-secondary);
        }

        .skeleton-cell { height: 16px; }
        .skeleton-cell.sm { width: 60px; }
        .skeleton-cell.md { width: 100px; }
        .skeleton-cell.lg { width: 150px; }

        .skeleton-locker {
            padding: var(--p-space-300) var(--p-space-400);
            border-bottom: 1px solid var(--p-color-border-secondary);
            display: flex;
            align-items: center;
            gap: var(--p-space-300);
        }

        .skeleton-checkbox {
            width: 18px;
            height: 18px;
            border-radius: 4px;
        }

        .skeleton-locker-info {
            flex: 1;
        }

        /* Onboarding reminder banner */
        .setup-reminder-banner {
            background: linear-gradient(90deg, #fef3c7 0%, #fde68a 100%);
            border: 1px solid #f59e0b;
            border-radius: var(--p-border-radius-200);
            padding: var(--p-space-300) var(--p-space-400);
            margin-bottom: var(--p-space-500);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: var(--p-space-300);
        }

        .setup-reminder-banner p {
            color: #92400e;
            font-size: var(--p-font-size-200);
            margin: 0;
        }

        .setup-reminder-banner .btn {
            flex-shrink: 0;
        }

        /* === MOBILE RESPONSIVE === */
        @media (max-width: 768px) {
            .header {
                padding: var(--p-space-300) var(--p-space-400);
                flex-direction: column;
                gap: var(--p-space-200);
                text-align: center;
            }

            .container {
                padding: var(--p-space-400);
            }

            .nav-tabs {
                flex-wrap: nowrap;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                padding-bottom: var(--p-space-100);
                gap: 0;
            }

            .tab {
                padding: var(--p-space-200) var(--p-space-300);
                font-size: var(--p-font-size-100);
                white-space: nowrap;
                flex-shrink: 0;
            }

            .card-header {
                flex-direction: column;
                gap: var(--p-space-300);
                align-items: flex-start;
            }

            .card-header .btn {
                width: 100%;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .stat-value {
                font-size: var(--p-font-size-500);
            }

            /* Orders table transforms to cards on mobile */
            .orders-table {
                border: none;
            }

            .orders-table thead {
                display: none;
            }

            .orders-table tbody {
                display: flex;
                flex-direction: column;
                gap: 12px;
            }

            .orders-table tr {
                display: block;
                background: var(--p-color-bg-surface);
                border: 1px solid var(--p-color-border-secondary);
                border-radius: var(--p-border-radius-200);
                padding: var(--p-space-400);
            }

            .orders-table tr:hover td {
                background: transparent;
            }

            .orders-table td {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 8px 0;
                border-bottom: 1px solid var(--p-color-border-secondary);
            }

            .orders-table td:last-child {
                border-bottom: none;
                padding-top: 12px;
                justify-content: flex-start;
            }

            .orders-table td::before {
                content: attr(data-label);
                font-weight: var(--p-font-weight-medium);
                color: var(--p-color-text-secondary);
                font-size: var(--p-font-size-100);
                flex-shrink: 0;
                margin-right: 12px;
            }

            .orders-table td:last-child::before {
                display: none;
            }

            /* Empty state in card view */
            .orders-table td.empty-state {
                display: block;
                border: none;
                padding: var(--p-space-600);
            }

            .orders-table td.empty-state::before {
                display: none;
            }

            .modal-content {
                margin: var(--p-space-400);
                width: calc(100% - var(--p-space-800));
                max-height: 85vh;
            }

            .detail-row {
                flex-direction: column;
                gap: var(--p-space-100);
            }

            .action-buttons {
                flex-direction: column;
            }

            .action-buttons .btn {
                width: 100%;
            }

            /* Settings page adjustments */
            .setting-row {
                flex-direction: column;
                align-items: flex-start !important;
                gap: 8px;
            }

            .setting-row input[type="number"] {
                width: 100% !important;
            }

            /* Filter buttons wrap nicely */
            .filter-btn {
                padding: 8px 12px;
                font-size: 11px;
            }

            /* Locker search controls */
            .locker-search-controls > div:first-child {
                flex-direction: column !important;
            }

            .locker-search-controls input[type="text"] {
                max-width: none !important;
            }

            .locker-search-controls > div:last-child {
                flex-direction: column !important;
                align-items: flex-start !important;
                gap: 12px !important;
            }

            /* Pagination on mobile */
            #locker-pagination > div {
                flex-direction: column;
                gap: 12px;
            }

            #locker-pagination .btn {
                flex: 1;
            }
        }

        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .header {
                padding: 10px 12px;
            }

            .logo {
                font-size: 18px;
            }

            .container {
                padding: 12px;
            }

            .tab {
                padding: 8px 12px;
                font-size: 12px;
            }

            .btn {
                padding: 8px 14px;
                font-size: 13px;
            }

            .btn-small {
                padding: 6px 10px;
                font-size: 11px;
            }
        }

        /* === LOCKER MAP === */
        #locker-map {
            height: 300px;
            border-radius: var(--p-border-radius-200);
            margin-bottom: var(--p-space-400);
            border: 1px solid var(--p-color-border-secondary);
        }

        .locker-map-marker {
            background: var(--p-color-bg-fill-brand);
            border: 2px solid white;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .locker-map-marker.selected {
            background: #008060;
            transform: scale(1.2);
        }

        .leaflet-popup-content {
            font-family: var(--p-font-family);
            font-size: 13px;
        }

        .leaflet-popup-content strong {
            display: block;
            margin-bottom: 4px;
        }
    </style>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>
    <div class="header">
        <div class="logo">üîê LockerDrop.it</div>
        <div class="user-info">
            <span id="store-name"></span>
        </div>
    </div>

    <!-- Reconnect Banner - shown when Shopify token is invalid -->
    <div id="reconnect-banner" style="display: none; background: #ffc107; color: #333; padding: 16px 24px; text-align: center; font-weight: 500;">
        <span id="reconnect-message">Your Shopify connection has expired. Some features may not work.</span>
        <button onclick="reconnectToShopify()" style="margin-left: 16px; padding: 8px 20px; background: #5c6ac4; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
            Reconnect to Shopify
        </button>
    </div>

    <!-- Scope Warning Banner - shown when fulfillment permissions are missing -->
    <div id="scope-warning-banner" style="display: none; background: #fff3cd; color: #856404; padding: 16px 24px; text-align: center; font-weight: 500; border-bottom: 1px solid #ffeeba;">
        <span id="scope-warning-message">Auto-fulfillment is disabled. Missing permission: write_fulfillments.</span>
        <button onclick="reconnectToShopify()" style="margin-left: 16px; padding: 8px 20px; background: #f58220; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
            Grant Permissions
        </button>
        <button onclick="dismissScopeWarning()" style="margin-left: 8px; padding: 8px 12px; background: transparent; color: #856404; border: 1px solid #856404; border-radius: 6px; cursor: pointer;">
            Dismiss
        </button>
    </div>

    <div class="container">
        <!-- Priority Action Banner (shows when action needed) -->
        <div id="priority-banner" class="priority-banner" style="display: none;">
            <div class="priority-content">
                <span class="priority-icon">üì¶</span>
                <div class="priority-text">
                    <strong>Next Action:</strong> <span id="priority-message">Drop off orders</span>
                </div>
                <div class="priority-actions">
                    <button class="btn btn-small btn-secondary" onclick="navigateToOrderFilter('pending_dropoff')">View Details</button>
                    <a id="priority-directions-btn" href="#" target="_blank" class="btn btn-small btn-primary" style="display: none;">Get Directions</a>
                </div>
            </div>
        </div>

        <!-- Stats -->
        <div class="stats-grid">
            <div class="stat-card stat-card-clickable" onclick="navigateToOrderFilter('pending_dropoff')" title="Click to view pending drop-off orders">
                <div class="stat-label">Pending Drop-offs</div>
                <div class="stat-value" id="stat-pending">0</div>
                <div class="stat-subtext" id="stat-pending-subtext"></div>
                <button class="stat-action-btn" onclick="event.stopPropagation(); navigateToOrderFilter('pending_dropoff')">View Orders ‚Üí</button>
            </div>
            <div class="stat-card stat-card-clickable" onclick="navigateToOrderFilter('ready_for_pickup')" title="Click to view orders ready for pickup">
                <div class="stat-label">Ready for Pickup</div>
                <div class="stat-value" id="stat-ready">0</div>
                <div class="stat-subtext" id="stat-ready-subtext"></div>
                <button class="stat-action-btn" onclick="event.stopPropagation(); navigateToOrderFilter('ready_for_pickup')">Monitor Status ‚Üí</button>
            </div>
            <div class="stat-card stat-card-clickable" onclick="navigateToOrderFilter('completed')" title="Click to view completed orders">
                <div class="stat-label">Completed This Week</div>
                <div class="stat-value" id="stat-completed">0</div>
                <div class="stat-subtext" id="stat-completed-subtext"></div>
                <button class="stat-action-btn" onclick="event.stopPropagation(); navigateToOrderFilter('completed')">View Report ‚Üí</button>
            </div>
            <div class="stat-card stat-card-clickable" onclick="navigateToOrderFilter('future_dropoff')" title="Click to view orders scheduled for future drop-off">
                <div class="stat-label">Future Drop-offs</div>
                <div class="stat-value" id="stat-future">0</div>
                <div class="stat-subtext" id="stat-future-subtext">Scheduled for later</div>
                <button class="stat-action-btn" onclick="event.stopPropagation(); navigateToOrderFilter('future_dropoff')">View Orders ‚Üí</button>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <button class="tab active" onclick="showTab('orders', this)">Orders</button>
            <button class="tab" onclick="showTab('lockers', this)" id="tab-lockers">My Lockers</button>
            <button class="tab" onclick="showTab('products', this)">Product Sizes</button>
            <button class="tab" onclick="showTab('settings', this)">Settings</button>
            <button class="tab" onclick="showTab('learn', this)">Learn</button>
            <button class="tab" onclick="showTab('billing', this)" style="display: none;">Billing</button>
        </div>

        <!-- Orders Tab -->
        <div id="orders" class="tab-content active">
            <div class="card">
                <div class="card-header">
                    <span class="card-header-title">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M4 2C3.44772 2 3 2.44772 3 3V17C3 17.5523 3.44772 18 4 18H16C16.5523 18 17 17.5523 17 17V3C17 2.44772 16.5523 2 16 2H4ZM5 4H15V6H5V4ZM5 8H15V10H5V8ZM5 12H11V14H5V12Z" fill="#5c6ac4"/>
                        </svg>
                        Orders
                    </span>
                    <button class="btn btn-primary" onclick="openManualOrderModal()">+ Add Manual Order</button>
                </div>
                <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 16px;">
                    <button class="filter-btn active" data-status="active" onclick="filterOrders('active')">Active</button>
                    <button class="filter-btn" data-status="pending_dropoff" onclick="filterOrders('pending_dropoff')">Pending Drop-off</button>
                    <button class="filter-btn" data-status="future_dropoff" onclick="filterOrders('future_dropoff')">Future Drop-off</button>
                    <button class="filter-btn" data-status="ready_for_pickup" onclick="filterOrders('ready_for_pickup')">Ready for Pickup</button>
                    <button class="filter-btn" data-status="completed" onclick="filterOrders('completed')">Completed</button>
                    <button class="filter-btn" data-status="cancelled" onclick="filterOrders('cancelled')">Cancelled</button>
                    <button class="filter-btn" data-status="all" onclick="filterOrders('all')">All</button>
                </div>
                <table class="orders-table">
                    <thead>
                        <tr>
                            <th class="sortable" data-sort="orderNumber" onclick="sortOrders('orderNumber')">Order #</th>
                            <th class="sortable" data-sort="date" onclick="sortOrders('date')">Date</th>
                            <th class="sortable" data-sort="pickupDate" onclick="sortOrders('pickupDate')">Pickup Date</th>
                            <th class="sortable" data-sort="customerName" onclick="sortOrders('customerName')">Customer</th>
                            <th class="sortable" data-sort="lockerName" onclick="sortOrders('lockerName')">Locker</th>
                            <th>Drop-off Link</th>
                            <th>Pickup Link</th>
                            <th class="sortable" data-sort="status" onclick="sortOrders('status')">Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="orders-table-body">
                        <tr>
                            <td colspan="9" class="empty-state">
                                <h3>Loading orders...</h3>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- My Lockers Tab -->
        <div id="lockers" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <span class="card-header-title">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M4 4C4 2.89543 4.89543 2 6 2H14C15.1046 2 16 2.89543 16 4V16C16 17.1046 15.1046 18 14 18H6C4.89543 18 4 17.1046 4 16V4ZM6 4V8H14V4H6ZM6 10V14H9V10H6ZM11 10V14H14V10H11ZM6 16H14V15H6V16Z" fill="#5c6ac4"/>
                        </svg>
                        My Lockers
                    </span>
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <span id="locker-selection-count" style="color: #6d7175; font-size: 14px;">Loading...</span>
                        <button id="save-lockers-btn" class="btn btn-primary" onclick="saveLockerPreferences()" disabled style="opacity: 0.5;">Save Changes</button>
                    </div>
                </div>
                <p class="card-description">Choose which lockers you're willing to use for deliveries. Selected lockers will appear as options at checkout.</p>

                <!-- Search and Filter Controls -->
                <div class="locker-search-controls" style="margin-bottom: 20px;">
                    <div style="display: flex; gap: 12px; flex-wrap: wrap; align-items: center; margin-bottom: 12px;">
                        <div style="flex: 1; min-width: 200px; max-width: 300px;">
                            <input type="text" id="locker-search" placeholder="Search by city or zip code..." class="form-input"
                                onkeypress="if(event.key==='Enter') searchLockers()">
                        </div>
                        <button class="btn btn-secondary" onclick="searchLockers()">Search</button>
                        <button class="btn btn-secondary" onclick="clearLockerSearch()" style="background: white;">Clear</button>
                    </div>
                    <div style="display: flex; gap: 16px; flex-wrap: wrap; align-items: center;">
                        <span style="color: #6d7175; font-size: 14px;">Filter:</span>
                        <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 14px;">
                            <input type="checkbox" class="size-filter" value="small" onchange="searchLockers()"> Small
                        </label>
                        <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 14px;">
                            <input type="checkbox" class="size-filter" value="medium" onchange="searchLockers()"> Medium
                        </label>
                        <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 14px;">
                            <input type="checkbox" class="size-filter" value="large" onchange="searchLockers()"> Large
                        </label>
                        <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 14px;">
                            <input type="checkbox" class="size-filter" value="x-large" onchange="searchLockers()"> X-Large
                        </label>
                        <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 14px; margin-left: 8px; padding-left: 16px; border-left: 1px solid #e1e3e5;">
                            <input type="checkbox" id="show-availability" onchange="searchLockers()"> Show availability
                        </label>
                        <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 14px; margin-left: 8px; padding-left: 16px; border-left: 1px solid #e1e3e5; color: #008060; font-weight: 500;">
                            <input type="checkbox" id="my-lockers-only" onchange="searchLockers()"> My lockers only
                        </label>
                    </div>
                </div>

                <!-- Locker Map -->
                <div id="locker-map"></div>

                <div class="locker-selector" id="locker-list">
                    <p style="padding: 20px 0; color: #6d7175;">Loading lockers...</p>
                </div>

                <!-- Pagination Controls -->
                <div id="locker-pagination" style="display: none; margin-top: 20px; padding-top: 16px; border-top: 1px solid #e1e3e5;">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;">
                        <span id="locker-page-info" style="color: #6d7175; font-size: 14px;">Showing 1-10 of 50 lockers</span>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn btn-secondary" id="prev-page-btn" onclick="prevLockerPage()" disabled>Previous</button>
                            <button class="btn btn-secondary" id="next-page-btn" onclick="nextLockerPage()">Next</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Product Sizes Tab -->
        <div id="products" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <span class="card-header-title">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M3 3H17V7H3V3ZM4 4V6H16V4H4ZM3 9H10V17H3V9ZM4 10V16H9V10H4ZM12 9H17V13H12V9ZM13 10V12H16V10H13ZM12 15H17V17H12V15Z" fill="#5c6ac4"/>
                        </svg>
                        Product Sizes
                    </span>
                    <button id="save-products-btn" class="btn btn-primary" onclick="saveProductSizes()">Save All Changes</button>
                </div>
                <div>
                    <p class="card-description" style="margin-bottom: 16px;">
                        Set dimensions for each product to ensure the right locker size is reserved.
                        For multi-item orders, dimensions are combined (stacked) to calculate total package size.
                    </p>

                    <div class="info-box tip" style="margin-bottom: 16px;">
                        <strong>Tip:</strong> Entering exact dimensions (L x W x H) allows multiple smaller items to share a locker.
                        Using only the dropdown assumes a default size.
                    </div>

                    <div class="info-box" style="margin-bottom: 16px; display: flex; flex-wrap: wrap; gap: 16px; align-items: center; font-size: 13px;">
                        <strong>Locker Sizes:</strong>
                        <span>Small: 12"√ó8"√ó4"</span>
                        <span>Medium: 16"√ó12"√ó8"</span>
                        <span>Large: 20"√ó16"√ó12"</span>
                        <span>X-Large: 24"√ó20"√ó16"</span>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr repeat(3, 70px) 120px; gap: 12px; padding: 8px 0; font-weight: 500; color: #6d7175; font-size: 13px; border-bottom: 1px solid #e1e3e5;">
                        <div>Product / Variant</div>
                        <div style="text-align: center;">L (in)</div>
                        <div style="text-align: center;">W (in)</div>
                        <div style="text-align: center;">H (in)</div>
                        <div style="text-align: center;">Locker Size</div>
                    </div>

                    <div id="products-list">
                        <p style="padding: 20px 0; color: #6d7175;">Loading products...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Learn Tab -->
        <div id="learn" class="tab-content">
            <!-- Getting Started Card -->
            <div class="card">
                <div class="card-header collapsible-header" onclick="toggleCollapse(this)">
                    <span class="card-header-title">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M10 2L3 6V14L10 18L17 14V6L10 2ZM10 4.18L14.5 6.75L10 9.32L5.5 6.75L10 4.18ZM5 8.35L9.5 10.92V15.65L5 13.08V8.35ZM10.5 15.65V10.92L15 8.35V13.08L10.5 15.65Z" fill="#5c6ac4"/>
                        </svg>
                        Getting Started
                    </span>
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <a href="/docs/training" target="_blank" class="btn btn-secondary btn-small" onclick="event.stopPropagation()">Training Guide</a>
                        <a href="/docs/faq" target="_blank" class="btn btn-secondary btn-small" onclick="event.stopPropagation()">FAQ</a>
                        <svg class="collapse-icon" width="20" height="20" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/></svg>
                    </div>
                </div>

                <div class="collapsible-content">
                <p class="card-description" style="margin-bottom: 16px;">Quick reference guides to get you up and running with LockerDrop.</p>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                    <!-- Quick Start -->
                    <div class="info-box" style="background: white; border: 1px solid #e1e3e5;">
                        <h4 style="margin: 0 0 12px; color: #5c6ac4; font-size: 15px;">Quick Start</h4>
                        <ol style="margin: 0 0 0 20px; padding: 0; line-height: 1.8; font-size: 14px;">
                            <li>Select locker locations in <strong>My Lockers</strong></li>
                            <li>Set product dimensions in <strong>Product Sizes</strong></li>
                            <li>Orders appear in <strong>Orders</strong> tab automatically</li>
                            <li>Click <strong>View</strong> to get your drop-off link</li>
                            <li>Open link on phone at locker to unlock</li>
                            <li>Place package and close door</li>
                            <li>Customer gets notified automatically</li>
                        </ol>
                    </div>

                    <!-- Order Lifecycle -->
                    <div class="info-box" style="background: white; border: 1px solid #e1e3e5;">
                        <h4 style="margin: 0 0 12px; color: #5c6ac4; font-size: 15px;">Order Lifecycle</h4>
                        <div style="font-size: 14px;">
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 10px;">
                                <span class="status-badge status-pending_dropoff">‚è≥ Waiting for drop-off</span>
                                <span style="color: #6d7175;">Your action needed</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 10px;">
                                <span class="status-badge status-ready_for_pickup">üì¶ In locker - notified</span>
                                <span style="color: #6d7175;">Customer got pickup email</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 10px;">
                                <span class="status-badge status-completed">‚úì Picked up</span>
                                <span style="color: #6d7175;">Order complete</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <span class="status-badge status-cancelled">‚úó Cancelled</span>
                                <span style="color: #6d7175;">Locker released</span>
                            </div>
                        </div>
                    </div>

                    <!-- Locker Sizes -->
                    <div class="info-box" style="background: white; border: 1px solid #e1e3e5;">
                        <h4 style="margin: 0 0 12px; color: #5c6ac4; font-size: 15px;">Locker Sizes</h4>
                        <table style="width: 100%; font-size: 14px;">
                            <tr style="border-bottom: 1px solid #e1e3e5;">
                                <td style="padding: 6px 0; font-weight: 500;">Small</td>
                                <td style="padding: 6px 0; color: #6d7175;">12" x 8" x 4"</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #e1e3e5;">
                                <td style="padding: 6px 0; font-weight: 500;">Medium</td>
                                <td style="padding: 6px 0; color: #6d7175;">16" x 12" x 8"</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #e1e3e5;">
                                <td style="padding: 6px 0; font-weight: 500;">Large</td>
                                <td style="padding: 6px 0; color: #6d7175;">20" x 16" x 12"</td>
                            </tr>
                            <tr>
                                <td style="padding: 6px 0; font-weight: 500;">X-Large</td>
                                <td style="padding: 6px 0; color: #6d7175;">24" x 20" x 16"</td>
                            </tr>
                        </table>
                        <p class="form-help" style="margin-top: 10px;">
                            Only lockers with available space show at checkout.
                        </p>
                    </div>

                    <!-- Product Sizes -->
                    <div class="info-box" style="background: white; border: 1px solid #e1e3e5;">
                        <h4 style="margin: 0 0 12px; color: #5c6ac4; font-size: 15px;">Setting Product Sizes</h4>
                        <div style="font-size: 14px; line-height: 1.6;">
                            <p style="margin: 0 0 8px;"><strong>Option 1: Exact Dimensions</strong> (Recommended)</p>
                            <p style="margin: 0 0 12px; color: #6d7175;">Enter L x W x H in inches. Allows multiple items to share a locker.</p>
                            <p style="margin: 0 0 8px;"><strong>Option 2: Locker Size Dropdown</strong></p>
                            <p style="margin: 0; color: #6d7175;">Quick option if you don't know exact dimensions.</p>
                        </div>
                    </div>

                    <!-- Multi-Item Orders -->
                    <div class="info-box" style="background: white; border: 1px solid #e1e3e5;">
                        <h4 style="margin: 0 0 12px; color: #5c6ac4; font-size: 15px;">Multi-Item Orders</h4>
                        <div style="font-size: 14px; line-height: 1.6;">
                            <p style="margin: 0 0 8px;">When customers order multiple items:</p>
                            <ul style="margin: 0 0 0 16px; padding: 0; color: #6d7175;">
                                <li>Heights are stacked together</li>
                                <li>System finds smallest fitting locker</li>
                                <li>Checkout shows available locations</li>
                            </ul>
                            <p style="margin: 10px 0 0; padding: 8px; background: #f6f6f7; border-radius: 4px; font-size: 13px;">
                                <strong>Example:</strong> Two 10"x6"x3" items = 10"x6"x6" ‚Üí Medium locker
                            </p>
                        </div>
                    </div>

                    <!-- Shopify Plus Checkout -->
                    <div class="info-box" style="background: white; border: 1px solid #e1e3e5;">
                        <h4 style="margin: 0 0 12px; color: #5c6ac4; font-size: 15px;">Shopify Plus Checkout</h4>
                        <div style="font-size: 14px; line-height: 1.6;">
                            <p style="margin: 0 0 8px;"><strong>For Plus Stores Only</strong></p>
                            <p style="margin: 0 0 8px; color: #6d7175;">
                                The checkout extension shows a locker selection widget directly in checkout.
                            </p>
                            <p style="margin: 0 0 8px;"><strong>To Enable:</strong></p>
                            <ol style="margin: 0 0 0 16px; padding: 0; color: #6d7175;">
                                <li>Go to Settings ‚Üí Checkout ‚Üí Customize</li>
                                <li>Click Apps in the left sidebar</li>
                                <li>Drag "LockerDrop Pickup" to checkout</li>
                                <li>Place after Delivery Address section</li>
                            </ol>
                            <p style="margin: 10px 0 0; padding: 8px; background: #fff8e5; border-radius: 4px; font-size: 13px; color: #8a6d3b;">
                                ‚ö†Ô∏è Requires extension deployment via Shopify CLI
                            </p>
                        </div>
                    </div>

                    <!-- Common Questions -->
                    <div class="info-box" style="background: white; border: 1px solid #e1e3e5;">
                        <h4 style="margin: 0 0 12px; color: #5c6ac4; font-size: 15px;">Common Questions</h4>
                        <div style="font-size: 14px; line-height: 1.6;">
                            <p style="margin: 0 0 10px;"><strong>Customer lost pickup info?</strong><br>
                            <span style="color: #6d7175;">Click View ‚Üí Resend Pickup Email</span></p>
                            <p style="margin: 0 0 10px;"><strong>Need to cancel?</strong><br>
                            <span style="color: #6d7175;">Click View ‚Üí Cancel Locker (releases the reservation)</span></p>
                            <p style="margin: 0 0 10px;"><strong>Door closed before I finished?</strong><br>
                            <span style="color: #6d7175;">Use the same drop-off link again to reopen</span></p>
                            <p style="margin: 0;"><strong>Not showing at checkout?</strong><br>
                            <span style="color: #6d7175;">Check: 1) Address verified 2) Product has size 3) Locker has space 4) Extension deployed</span></p>
                        </div>
                    </div>
                </div>
                </div>
            </div>

            <!-- Theme Blocks Card -->
            <div class="card">
                <div class="card-header collapsible-header" onclick="toggleCollapse(this)">
                    <span class="card-header-title">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M3 3H9V9H3V3ZM5 5V7H7V5H5ZM11 3H17V9H11V3ZM13 5V7H15V5H13ZM3 11H9V17H3V11ZM5 13V15H7V13H5ZM11 11H17V17H11V11ZM13 13V15H15V13H13Z" fill="#5c6ac4"/>
                        </svg>
                        Theme Blocks for Your Store
                    </span>
                    <svg class="collapse-icon" width="20" height="20" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/></svg>
                </div>
                <div class="collapsible-content">
                <p class="card-description">
                    Add these blocks to promote LockerDrop on your store. Go to <strong>Online Store ‚Üí Themes ‚Üí Customize ‚Üí Apps</strong>.
                </p>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px;">
                    <!-- LockerDrop Badge -->
                    <div style="border: 1px solid #e1e3e5; border-radius: 8px; overflow: hidden;">
                        <div style="background: #f9fafb; padding: 20px; border-bottom: 1px solid #e1e3e5;">
                            <div style="background: white; border: 1px solid #e1e3e5; border-radius: 6px; padding: 12px; display: inline-flex; align-items: center; gap: 8px;">
                                <svg width="16" height="16" viewBox="0 0 20 20" fill="#5c6ac4"><path d="M4 4C4 2.89543 4.89543 2 6 2H14C15.1046 2 16 2.89543 16 4V16C16 17.1046 15.1046 18 14 18H6C4.89543 18 4 17.1046 4 16V4Z"/></svg>
                                <span style="font-size: 13px; color: #5c6ac4; font-weight: 500;">Available for Locker Pickup</span>
                            </div>
                        </div>
                        <div style="padding: 16px;">
                            <strong style="font-size: 14px;">LockerDrop Badge</strong>
                            <p style="margin: 6px 0 0; font-size: 13px; color: #6d7175;">Shows on product pages near Add to Cart button</p>
                        </div>
                    </div>

                    <!-- Cart Reminder -->
                    <div style="border: 1px solid #e1e3e5; border-radius: 8px; overflow: hidden;">
                        <div style="background: #f9fafb; padding: 20px; border-bottom: 1px solid #e1e3e5;">
                            <div style="background: #e8f4fd; border-radius: 6px; padding: 12px; font-size: 12px;">
                                <div style="font-weight: 600; margin-bottom: 8px; color: #202223;">Skip the wait - Pick up from a locker!</div>
                                <div style="display: flex; gap: 16px; color: #6d7175;">
                                    <span>1. Select locker</span>
                                    <span>2. Get notified</span>
                                    <span>3. Pick up anytime</span>
                                </div>
                            </div>
                        </div>
                        <div style="padding: 16px;">
                            <strong style="font-size: 14px;">Cart Reminder</strong>
                            <p style="margin: 6px 0 0; font-size: 13px; color: #6d7175;">3-step guide shown on cart page</p>
                        </div>
                    </div>

                    <!-- Steps Banner -->
                    <div style="border: 1px solid #e1e3e5; border-radius: 8px; overflow: hidden;">
                        <div style="background: #f9fafb; padding: 20px; border-bottom: 1px solid #e1e3e5;">
                            <div style="display: flex; justify-content: space-around; text-align: center; font-size: 11px;">
                                <div><div style="width: 32px; height: 32px; background: #5c6ac4; border-radius: 50%; color: white; display: flex; align-items: center; justify-content: center; margin: 0 auto 6px;">1</div>Shop</div>
                                <div><div style="width: 32px; height: 32px; background: #5c6ac4; border-radius: 50%; color: white; display: flex; align-items: center; justify-content: center; margin: 0 auto 6px;">2</div>Select Locker</div>
                                <div><div style="width: 32px; height: 32px; background: #5c6ac4; border-radius: 50%; color: white; display: flex; align-items: center; justify-content: center; margin: 0 auto 6px;">3</div>Pick Up</div>
                            </div>
                        </div>
                        <div style="padding: 16px;">
                            <strong style="font-size: 14px;">Steps Banner</strong>
                            <p style="margin: 6px 0 0; font-size: 13px; color: #6d7175;">"How It Works" section for homepage</p>
                        </div>
                    </div>

                    <!-- Locker Finder -->
                    <div style="border: 1px solid #e1e3e5; border-radius: 8px; overflow: hidden;">
                        <div style="background: #f9fafb; padding: 20px; border-bottom: 1px solid #e1e3e5;">
                            <div style="background: white; border: 1px solid #c4cdd5; border-radius: 6px; padding: 10px 12px; display: flex; align-items: center; gap: 8px; font-size: 13px; color: #6d7175;">
                                <svg width="14" height="14" viewBox="0 0 20 20" fill="#6d7175"><path d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z"/></svg>
                                Enter zip code to find lockers...
                            </div>
                        </div>
                        <div style="padding: 16px;">
                            <strong style="font-size: 14px;">Locker Finder</strong>
                            <p style="margin: 6px 0 0; font-size: 13px; color: #6d7175;">Zip code search showing nearby locations</p>
                        </div>
                    </div>

                    <!-- Promo Banner -->
                    <div style="border: 1px solid #e1e3e5; border-radius: 8px; overflow: hidden;">
                        <div style="background: #5c6ac4; padding: 16px; border-bottom: 1px solid #e1e3e5; text-align: center;">
                            <span style="color: white; font-size: 13px; font-weight: 500;">New! Pick up orders from secure lockers near you</span>
                        </div>
                        <div style="padding: 16px;">
                            <strong style="font-size: 14px;">Promo Banner</strong>
                            <p style="margin: 6px 0 0; font-size: 13px; color: #6d7175;">Eye-catching announcement for header</p>
                        </div>
                    </div>

                    <!-- Info Page -->
                    <div style="border: 1px solid #e1e3e5; border-radius: 8px; overflow: hidden;">
                        <div style="background: #f9fafb; padding: 20px; border-bottom: 1px solid #e1e3e5;">
                            <div style="text-align: center;">
                                <div style="font-weight: 600; font-size: 14px; margin-bottom: 4px;">How LockerDrop Works</div>
                                <div style="font-size: 11px; color: #6d7175;">Full page with hero, steps, benefits & FAQ</div>
                            </div>
                        </div>
                        <div style="padding: 16px;">
                            <strong style="font-size: 14px;">Info Page</strong>
                            <p style="margin: 6px 0 0; font-size: 13px; color: #6d7175;">Create a dedicated "How It Works" page</p>
                        </div>
                    </div>
                </div>

                <div class="info-box success" style="margin-top: 20px;">
                    <strong style="color: #008060;">How to add:</strong>
                    <span style="color: #6d7175;"> Online Store ‚Üí Themes ‚Üí Customize ‚Üí navigate to page ‚Üí Add block/section ‚Üí find under Apps</span>
                </div>
                </div>
            </div>

            <!-- Need Help - Bottom of Learn Tab -->
            <div class="info-box" style="margin-top: 0;">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;">
                    <div>
                        <strong style="font-size: 15px;">Need Help?</strong>
                        <span style="color: #6d7175; margin-left: 12px;">support@lockerdrop.it</span>
                    </div>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <a href="/docs/training" target="_blank" style="color: #5c6ac4; font-size: 13px;">Training Guide</a>
                        <span style="color: #e1e3e5;">|</span>
                        <a href="/docs/faq" target="_blank" style="color: #5c6ac4; font-size: 13px;">FAQ</a>
                        <span style="color: #e1e3e5;">|</span>
                        <a href="/docs/customer-faq" target="_blank" style="color: #5c6ac4; font-size: 13px;">Customer FAQ</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Billing Tab -->
        <div id="billing" class="tab-content">
            <!-- Current Subscription Status -->
            <div class="card">
                <div class="card-header">
                    <span class="card-header-title">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M3 5C3 3.89543 3.89543 3 5 3H15C16.1046 3 17 3.89543 17 5V15C17 16.1046 16.1046 17 15 17H5C3.89543 17 3 16.1046 3 15V5ZM5 5V7H15V5H5ZM5 9V15H15V9H5ZM7 11H10V13H7V11Z" fill="#5c6ac4"/>
                        </svg>
                        Current Subscription
                    </span>
                </div>
                <div id="subscription-status">
                    <p style="color: #6d7175;">Loading subscription status...</p>
                </div>
            </div>

            <!-- Usage Meter -->
            <div class="card" id="usage-card" style="display: none;">
                <div class="card-header">
                    <span class="card-header-title">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M3 16H17V18H3V16ZM5 9H7V15H5V9ZM9 5H11V15H9V5ZM13 11H15V15H13V11Z" fill="#5c6ac4"/>
                        </svg>
                        Monthly Usage
                    </span>
                </div>
                <div id="usage-meter">
                    <div style="margin-bottom: 12px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span>Orders this month</span>
                            <span id="usage-count" style="font-weight: 500;">0 / 0</span>
                        </div>
                        <div style="background: #e1e3e5; height: 8px; border-radius: 4px; overflow: hidden;">
                            <div id="usage-bar" style="background: #5c6ac4; height: 100%; width: 0%; transition: width 0.3s;"></div>
                        </div>
                    </div>
                    <p id="usage-message" class="form-help"></p>
                </div>
            </div>

            <!-- Available Plans -->
            <div class="card">
                <div class="card-header">
                    <span class="card-header-title">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M10 2C5.58172 2 2 5.58172 2 10C2 14.4183 5.58172 18 10 18C14.4183 18 18 14.4183 18 10C18 5.58172 14.4183 2 10 2ZM10.5 14V15H9.5V14H8V13H11C11.2761 13 11.5 12.7761 11.5 12.5C11.5 12.2239 11.2761 12 11 12H9C8.17157 12 7.5 11.3284 7.5 10.5C7.5 9.67157 8.17157 9 9 9H9.5V8H10.5V9H12V10H9C8.72386 10 8.5 10.2239 8.5 10.5C8.5 10.7761 8.72386 11 9 11H11C11.8284 11 12.5 11.6716 12.5 12.5C12.5 13.3284 11.8284 14 11 14H10.5Z" fill="#5c6ac4"/>
                        </svg>
                        Available Plans
                    </span>
                </div>
                <p class="card-description">Choose the plan that fits your business needs.</p>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">
                    <!-- Basic Plan -->
                    <div class="plan-card" data-plan="basic" style="border: 2px solid #e1e3e5; border-radius: 12px; padding: 24px; position: relative;">
                        <h3 style="font-size: 20px; margin-bottom: 8px;">Basic</h3>
                        <div style="margin-bottom: 16px;">
                            <span style="font-size: 36px; font-weight: 700;">$9</span>
                            <span style="color: #6d7175;">/month</span>
                        </div>
                        <ul style="list-style: none; margin-bottom: 24px; line-height: 2;">
                            <li>&#10003; 25 LockerDrop orders/month</li>
                            <li>&#10003; Email notifications</li>
                            <li>&#10003; Basic support</li>
                            <li>&#10003; Dashboard access</li>
                        </ul>
                        <button class="btn btn-secondary plan-btn" style="width: 100%;" onclick="subscribeToPlan('basic')">Select Basic</button>
                    </div>

                    <!-- Pro Plan (Popular) -->
                    <div class="plan-card" data-plan="pro" style="border: 2px solid #5c6ac4; border-radius: 12px; padding: 24px; position: relative; background: linear-gradient(135deg, #f4f5fa 0%, #fff 100%);">
                        <span style="position: absolute; top: -12px; left: 50%; transform: translateX(-50%); background: #5c6ac4; color: white; padding: 4px 16px; border-radius: 12px; font-size: 12px; font-weight: 600;">MOST POPULAR</span>
                        <h3 style="font-size: 20px; margin-bottom: 8px;">Pro</h3>
                        <div style="margin-bottom: 16px;">
                            <span style="font-size: 36px; font-weight: 700;">$29</span>
                            <span style="color: #6d7175;">/month</span>
                        </div>
                        <ul style="list-style: none; margin-bottom: 24px; line-height: 2;">
                            <li>&#10003; 100 LockerDrop orders/month</li>
                            <li>&#10003; Email & SMS notifications</li>
                            <li>&#10003; Priority support</li>
                            <li>&#10003; Dashboard access</li>
                            <li>&#10003; Analytics</li>
                        </ul>
                        <button class="btn btn-primary plan-btn" style="width: 100%;" onclick="subscribeToPlan('pro')">Select Pro</button>
                    </div>

                    <!-- Enterprise Plan -->
                    <div class="plan-card" data-plan="enterprise" style="border: 2px solid #e1e3e5; border-radius: 12px; padding: 24px; position: relative;">
                        <h3 style="font-size: 20px; margin-bottom: 8px;">Enterprise</h3>
                        <div style="margin-bottom: 16px;">
                            <span style="font-size: 36px; font-weight: 700;">$99</span>
                            <span style="color: #6d7175;">/month</span>
                        </div>
                        <ul style="list-style: none; margin-bottom: 24px; line-height: 2;">
                            <li>&#10003; <strong>Unlimited</strong> orders</li>
                            <li>&#10003; Email & SMS notifications</li>
                            <li>&#10003; Dedicated support</li>
                            <li>&#10003; Checkout UI block</li>
                            <li>&#10003; Order status page block</li>
                            <li>&#10003; <strong>Custom branded pickup page</strong></li>
                            <li>&#10003; Upsell widgets</li>
                            <li>&#10003; Rebuy integration</li>
                        </ul>
                        <button class="btn btn-secondary plan-btn" style="width: 100%;" onclick="subscribeToPlan('enterprise')">Select Enterprise</button>
                    </div>
                </div>

                <p style="margin-top: 20px; color: #6d7175; font-size: 13px; text-align: center;">
                    All plans include a 3-day free trial. Cancel anytime.
                </p>
            </div>

            <!-- Dev Mode Plan Switcher (only for test stores) -->
            <div class="card" id="dev-mode-card" style="display: none; background: #fff4e6; border: 2px dashed #996300;">
                <div class="card-header" style="color: #996300;">
                    üîß Dev Mode - Free Plan Switching
                </div>
                <p style="color: #6d7175; margin-bottom: 16px;">
                    Test store detected. Switch between plans freely without billing.
                </p>
                <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                    <button class="btn" style="background: #f6f6f7;" onclick="devSwitchPlan('basic')">Switch to Basic</button>
                    <button class="btn" style="background: #f6f6f7;" onclick="devSwitchPlan('pro')">Switch to Pro</button>
                    <button class="btn" style="background: #5c6ac4; color: white;" onclick="devSwitchPlan('enterprise')">Switch to Enterprise</button>
                </div>
            </div>

            <!-- Cancel Subscription -->
            <div class="card" id="cancel-card" style="display: none;">
                <div class="card-header">Cancel Subscription</div>
                <p style="color: #6d7175; margin-bottom: 16px;">
                    If you cancel, your subscription will remain active until the end of the current billing period.
                </p>
                <button class="btn" style="background: #bf0711; color: white;" onclick="cancelSubscription()">Cancel Subscription</button>
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="settings" class="tab-content">
            <!-- Auto-save Status -->
            <div id="settings-save-status" style="display: none; padding: 12px 16px; background: #e3f5ef; border-radius: 8px; margin-bottom: 20px; color: #008060; font-size: 14px;">
                <svg width="16" height="16" viewBox="0 0 20 20" fill="#008060" style="vertical-align: middle; margin-right: 8px;"><path d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"/></svg>
                <span>Settings saved</span>
            </div>

            <!-- Pricing Section -->
            <div class="card">
                <div class="card-header">
                    <span class="card-header-title">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M10 2C5.58172 2 2 5.58172 2 10C2 14.4183 5.58172 18 10 18C14.4183 18 18 14.4183 18 10C18 5.58172 14.4183 2 10 2ZM10.5 14V15H9.5V14H8V13H11C11.2761 13 11.5 12.7761 11.5 12.5C11.5 12.2239 11.2761 12 11 12H9C8.17157 12 7.5 11.3284 7.5 10.5C7.5 9.67157 8.17157 9 9 9H9.5V8H10.5V9H12V10H9C8.72386 10 8.5 10.2239 8.5 10.5C8.5 10.7761 8.72386 11 9 11H11C11.8284 11 12.5 11.6716 12.5 12.5C12.5 13.3284 11.8284 14 11 14H10.5Z" fill="#5c6ac4"/>
                        </svg>
                        Pricing
                    </span>
                </div>
                <p class="card-description">Configure what customers pay for locker pickup at checkout.</p>

                <div class="two-column-grid">
                    <label style="display: flex; align-items: flex-start; gap: 12px; cursor: pointer;">
                        <input type="checkbox" id="free-pickup" style="width: 18px; height: 18px; cursor: pointer; margin-top: 2px; flex-shrink: 0;" onchange="autoSaveSettings()">
                        <div>
                            <span style="font-weight: 500;">Offer Free Locker Pickup</span>
                            <p class="form-help" style="margin-top: 4px;">Customers see $0.00 at checkout. You absorb the fees.</p>
                        </div>
                    </label>
                    <div id="pricing-info" class="info-box">
                        <div id="pricing-display">
                            <strong>Customer pays:</strong> <span id="customer-price" style="color: #008060; font-size: 18px; font-weight: 600;">$1.00</span>
                            <p style="color: #6d7175; margin: 4px 0 0 0; font-size: 13px;">LockerDrop service fee at checkout</p>
                        </div>
                    </div>
                </div>

                <!-- Checkout Extension Toggle (for Plus stores) -->
                <div class="form-group" style="margin-top: 24px; padding-top: 24px; border-top: 1px solid #e1e3e5;">
                    <label class="toggle-label" style="display: flex; align-items: flex-start; gap: 12px; cursor: pointer;">
                        <input type="checkbox" id="use-checkout-extension" onchange="autoSaveSettings()">
                        <div>
                            <span style="font-weight: 500;">Use Checkout Extension (Plus Only)</span>
                            <p class="form-help" style="margin-top: 4px;">Enable if you've added the LockerDrop widget in Checkout Customizer. This hides locker options from the shipping method list to prevent duplicates.</p>
                        </div>
                    </label>
                    <div id="extension-mode-info" class="info-box" style="margin-top: 12px; background: #f4f6f8; border: 1px solid #e1e3e5;">
                        <div style="font-size: 13px; color: #6d7175;">
                            <strong>When enabled:</strong> Locker selection appears only in your checkout extension widget.<br>
                            <strong>When disabled:</strong> Locker options appear as shipping methods (for non-Plus stores).
                        </div>
                    </div>
                </div>
                <span id="checkout-mode-save-status" style="display: none;"></span>
            </div>

            <!-- Fulfillment & Timing Section -->
            <div class="card">
                <div class="card-header">
                    <span class="card-header-title">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M6 2C6 1.44772 6.44772 1 7 1C7.55228 1 8 1.44772 8 2V3H12V2C12 1.44772 12.4477 1 13 1C13.5523 1 14 1.44772 14 2V3H15C16.1046 3 17 3.89543 17 5V16C17 17.1046 16.1046 18 15 18H5C3.89543 18 3 17.1046 3 16V5C3 3.89543 3.89543 3 5 3H6V2ZM5 8V16H15V8H5ZM7 10H9V12H7V10ZM11 10H13V12H11V10Z" fill="#5c6ac4"/>
                        </svg>
                        Fulfillment & Timing
                    </span>
                </div>
                <p class="card-description">Configure when you can fulfill orders and how long items stay in lockers.</p>

                <div class="two-column-grid">
                    <!-- Left Column: Schedule -->
                    <div>
                        <div class="form-group">
                            <label class="form-label">Processing Time</label>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <input type="number" id="processing-days" min="0" max="14" value="1" class="form-input" style="width: 80px;" onchange="autoSaveSettings()">
                                <span style="color: #6d7175;">business day(s)</span>
                            </div>
                            <p class="form-help">Time needed to prepare orders for dropoff</p>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Fulfillment Days</label>
                            <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                                <label style="display: flex; align-items: center; gap: 6px; padding: 8px 12px; background: #f6f6f7; border-radius: 6px; cursor: pointer;">
                                    <input type="checkbox" class="fulfillment-day" value="monday" checked onchange="autoSaveSettings()"> Mon
                                </label>
                                <label style="display: flex; align-items: center; gap: 6px; padding: 8px 12px; background: #f6f6f7; border-radius: 6px; cursor: pointer;">
                                    <input type="checkbox" class="fulfillment-day" value="tuesday" checked onchange="autoSaveSettings()"> Tue
                                </label>
                                <label style="display: flex; align-items: center; gap: 6px; padding: 8px 12px; background: #f6f6f7; border-radius: 6px; cursor: pointer;">
                                    <input type="checkbox" class="fulfillment-day" value="wednesday" checked onchange="autoSaveSettings()"> Wed
                                </label>
                                <label style="display: flex; align-items: center; gap: 6px; padding: 8px 12px; background: #f6f6f7; border-radius: 6px; cursor: pointer;">
                                    <input type="checkbox" class="fulfillment-day" value="thursday" checked onchange="autoSaveSettings()"> Thu
                                </label>
                                <label style="display: flex; align-items: center; gap: 6px; padding: 8px 12px; background: #f6f6f7; border-radius: 6px; cursor: pointer;">
                                    <input type="checkbox" class="fulfillment-day" value="friday" checked onchange="autoSaveSettings()"> Fri
                                </label>
                                <label style="display: flex; align-items: center; gap: 6px; padding: 8px 12px; background: #f6f6f7; border-radius: 6px; cursor: pointer;">
                                    <input type="checkbox" class="fulfillment-day" value="saturday" onchange="autoSaveSettings()"> Sat
                                </label>
                                <label style="display: flex; align-items: center; gap: 6px; padding: 8px 12px; background: #f6f6f7; border-radius: 6px; cursor: pointer;">
                                    <input type="checkbox" class="fulfillment-day" value="sunday" onchange="autoSaveSettings()"> Sun
                                </label>
                            </div>
                            <p class="form-help">Days you can drop off orders to lockers</p>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Hold Time</label>
                            <select id="hold-time" class="form-input" onchange="autoSaveSettings()">
                                <option value="3">3 days</option>
                                <option value="5" selected>5 days</option>
                                <option value="7">7 days</option>
                                <option value="10">10 days</option>
                            </select>
                            <p class="form-help">How long items are held before being returned to you</p>
                        </div>
                    </div>

                    <!-- Right Column: Vacation & Preview -->
                    <div>
                        <div class="form-group">
                            <label class="form-label">Vacation Days</label>
                            <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px; align-items: center;">
                                <div style="display: flex; align-items: center; gap: 6px; flex: 1; min-width: 200px;">
                                    <input type="date" id="vacation-start-date" class="form-input" style="flex: 1;" onchange="updateVacationButtonText()">
                                    <span style="color: #6d7175;">to</span>
                                    <input type="date" id="vacation-end-date" class="form-input" style="flex: 1;" onchange="updateVacationButtonText()">
                                </div>
                                <button type="button" id="add-vacation-btn" class="btn btn-secondary" onclick="addVacationDays()">Add</button>
                            </div>
                            <div id="vacation-days-list" style="display: flex; flex-wrap: wrap; gap: 8px; min-height: 36px;"></div>
                            <p class="form-help">Select one date or a range, then click Add.</p>
                        </div>

                        <div id="pickup-preview" class="info-box success" style="margin-top: 24px;">
                            <strong style="color: #008060; display: block; margin-bottom: 4px;">Pickup Date Preview</strong>
                            <span id="pickup-preview-text" style="font-size: 14px;">Customers ordering today will see pickup available <strong>Tomorrow</strong></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Hidden last-refresh span for backwards compatibility -->
            <span id="last-refresh" style="display: none;">--</span>

            <!-- Branding Section -->
            <div class="card">
                <div class="card-header">
                    <span class="card-header-title">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M4 3C3.44772 3 3 3.44772 3 4V16C3 16.5523 3.44772 17 4 17H16C16.5523 17 17 16.5523 17 16V4C17 3.44772 16.5523 3 16 3H4ZM5 5H15V10H5V5ZM5 12H9V15H5V12ZM11 12H15V15H11V12Z" fill="#5c6ac4"/>
                        </svg>
                        Pickup Page Branding
                    </span>
                </div>
                <div id="branding-content">
                    <p class="card-description" style="margin-bottom: 16px;">
                        Customize the success page customers see after picking up their order.
                        <a id="branding-preview-link" href="#" target="_blank" style="color: #5c6ac4; margin-left: 8px;">Preview Page</a>
                    </p>

                    <div class="two-column-grid">
                        <!-- Brand Identity -->
                        <div>
                            <h4 style="margin-bottom: 16px; color: #202223; font-size: 15px;">Brand Identity</h4>
                            <div class="form-group">
                                <label class="form-label">Logo</label>
                                <div id="logo-preview-container" style="margin-bottom: 12px; display: none;">
                                    <img id="logo-preview" src="" alt="Logo preview" style="max-width: 200px; max-height: 80px; border: 1px solid #e1e3e5; border-radius: 6px; padding: 8px; background: #f9fafb;">
                                    <button type="button" onclick="removeLogo()" style="display: block; margin-top: 8px; background: none; border: none; color: #bf0711; cursor: pointer; font-size: 13px;">Remove</button>
                                </div>
                                <div id="logo-upload-container">
                                    <input type="file" id="branding-logo-file" accept="image/jpeg,image/png,image/gif,image/webp,image/svg+xml" style="display: none;" onchange="handleLogoSelect(event)">
                                    <button type="button" onclick="document.getElementById('branding-logo-file').click()" class="btn btn-secondary" style="width: 100%;">Choose Logo</button>
                                </div>
                                <input type="hidden" id="branding-logo" value="">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Primary Color</label>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="color" id="branding-primary-color" value="#5c6ac4" style="width: 50px; height: 40px; border: 1px solid #c4cdd5; border-radius: 6px; cursor: pointer;" onchange="autoSaveBranding()">
                                    <input type="text" id="branding-primary-color-text" value="#5c6ac4" class="form-input" style="width: 100px;" onchange="autoSaveBranding()">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Success Message</label>
                                <textarea id="branding-success-message" rows="2" placeholder="Thank you for picking up your order!" class="form-input" style="resize: vertical;" onchange="autoSaveBranding()"></textarea>
                            </div>
                        </div>

                        <!-- Upsells -->
                        <div>
                            <h4 style="margin-bottom: 16px; color: #202223; font-size: 15px;">Upsell Products</h4>
                            <div class="form-group">
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" id="branding-show-upsells" checked onchange="autoSaveBranding()">
                                    <span>Show upsell products on success page</span>
                                </label>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Upsell Heading</label>
                                <input type="text" id="branding-upsell-heading" value="You might also like" class="form-input" onchange="autoSaveBranding()">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Products (max 4)</label>
                                <div id="selected-upsell-products" style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 12px;"></div>
                                <div id="upsell-product-search-container" style="position: relative;">
                                    <input type="text" id="upsell-product-search" placeholder="Search products..." class="form-input" oninput="searchUpsellProducts(this.value)" onfocus="showProductDropdown()">
                                    <div id="upsell-product-dropdown" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #c4cdd5; border-top: none; border-radius: 0 0 6px 6px; max-height: 200px; overflow-y: auto; z-index: 100; box-shadow: 0 4px 12px rgba(0,0,0,0.15);"></div>
                                </div>
                                <input type="hidden" id="branding-upsell-products" value="">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Order Detail Modal -->
    <div id="orderModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2 style="margin-bottom: 20px;">Order Details</h2>

            <div class="order-details">
                <div class="detail-row">
                    <span class="detail-label">Order Number:</span>
                    <span id="modal-order-number">#1001</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Customer:</span>
                    <span id="modal-customer">John Smith</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Customer Email:</span>
                    <span id="modal-email">john@example.com</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Customer Phone:</span>
                    <span id="modal-phone">Not provided</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Locker Location:</span>
                    <span id="modal-locker">Not assigned</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Status:</span>
                    <span id="modal-status">Pending</span>
                </div>
            </div>

            <div id="dropoff-section" style="margin-top: 24px;">
                <h3 style="margin-bottom: 12px;">üì¶ Ready to Drop Off?</h3>
                <div id="dropoff-content">Loading...</div>
            </div>

            <div id="pickup-section" style="margin-top: 24px;">
                <h3 style="margin-bottom: 12px;">Customer Pickup Link</h3>
                <div id="pickup-content">Loading...</div>
            </div>

            <div style="margin-top: 24px; display: flex; gap: 12px; flex-wrap: wrap;">
                <button id="btn-mark-dropped" class="btn btn-primary" onclick="markAsDroppedOff()">Mark as Dropped Off</button>
                <button class="btn btn-secondary" onclick="resendCustomerEmail()">Resend Pickup Email</button>
                <button id="btn-cancel-locker" class="btn btn-danger" onclick="cancelLockerRequest()" style="background: #d72c0d; color: white;">Cancel Locker</button>
            </div>
        </div>
    </div>

    <!-- Manual Order Modal -->
    <div id="manualOrderModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeManualOrderModal()">&times;</span>
            <h2 style="margin-bottom: 20px;">Add Manual Order</h2>

            <form id="manualOrderForm" onsubmit="submitManualOrder(event)">
                <div style="margin-bottom: 16px;">
                    <label style="display: block; font-weight: 500; margin-bottom: 8px;">Order Number / Reference *</label>
                    <input type="text" id="manual-order-number" required placeholder="e.g., 1031 or MANUAL-001"
                           style="width: 100%; padding: 10px; border: 1px solid #c4cdd5; border-radius: 6px;">
                </div>

                <div style="margin-bottom: 16px;">
                    <label style="display: block; font-weight: 500; margin-bottom: 8px;">Customer Name *</label>
                    <input type="text" id="manual-customer-name" required placeholder="John Smith"
                           style="width: 100%; padding: 10px; border: 1px solid #c4cdd5; border-radius: 6px;">
                </div>

                <div style="margin-bottom: 16px;">
                    <label style="display: block; font-weight: 500; margin-bottom: 8px;">Customer Email *</label>
                    <input type="email" id="manual-customer-email" required placeholder="customer@example.com"
                           style="width: 100%; padding: 10px; border: 1px solid #c4cdd5; border-radius: 6px;">
                </div>

                <div style="margin-bottom: 16px;">
                    <label style="display: block; font-weight: 500; margin-bottom: 8px;">Locker Location *</label>
                    <select id="manual-locker-select" required
                            style="width: 100%; padding: 10px; border: 1px solid #c4cdd5; border-radius: 6px;">
                        <option value="">Select a locker...</option>
                    </select>
                </div>

                <div style="margin-bottom: 16px;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="manual-send-email" checked>
                        <span>Send pickup email to customer when item is dropped off</span>
                    </label>
                </div>

                <div style="display: flex; gap: 12px; margin-top: 24px;">
                    <button type="submit" class="btn btn-primary">Create Order</button>
                    <button type="button" class="btn btn-secondary" onclick="closeManualOrderModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Onboarding Wizard Modal -->
    <div id="onboardingModal" class="modal onboarding-modal">
        <div class="modal-content">
            <div class="onboarding-header">
                <h2>Welcome to LockerDrop!</h2>
                <p>Let's get you set up in just 3 quick steps</p>
            </div>

            <div class="onboarding-progress">
                <div class="progress-step active" data-step="1">
                    <span class="step-number">1</span>
                    <span>Select Lockers</span>
                </div>
                <div class="progress-step" data-step="2">
                    <span class="step-number">2</span>
                    <span>Product Sizes</span>
                </div>
                <div class="progress-step" data-step="3">
                    <span class="step-number">3</span>
                    <span>Schedule</span>
                </div>
            </div>

            <div class="onboarding-body">
                <!-- Step 1: Select Lockers -->
                <div class="onboarding-step active" data-step="1">
                    <h3>Choose Your Locker Locations</h3>
                    <p>Select which locker locations you want to offer customers at checkout.</p>
                    <div class="onboarding-tip">
                        üí° <strong>Tip:</strong> Start with 2-3 lockers near your store or in popular customer areas.
                    </div>
                    <div style="background: var(--p-color-bg-surface-secondary); border-radius: var(--p-border-radius-200); padding: var(--p-space-400); text-align: center;">
                        <p style="margin-bottom: var(--p-space-300);">You'll configure lockers in the <strong>My Lockers</strong> tab</p>
                        <button class="btn btn-secondary" onclick="goToLockersTab()">
                            üìç Go to My Lockers Tab
                        </button>
                    </div>
                </div>

                <!-- Step 2: Product Sizes -->
                <div class="onboarding-step" data-step="2">
                    <h3>Set Up Product Sizes</h3>
                    <p>Configure product dimensions so we can match them with the right locker size.</p>
                    <div class="onboarding-tip">
                        üí° <strong>Tip:</strong> You can set exact dimensions or just choose Small/Medium/Large/X-Large for each product.
                    </div>
                    <div style="background: var(--p-color-bg-surface-secondary); border-radius: var(--p-border-radius-200); padding: var(--p-space-400);">
                        <p style="margin-bottom: var(--p-space-200); font-weight: 500;">Locker size reference:</p>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; font-size: 13px;">
                            <div><strong>S:</strong> 12" √ó 8" √ó 4"</div>
                            <div><strong>M:</strong> 16" √ó 12" √ó 8"</div>
                            <div><strong>L:</strong> 20" √ó 16" √ó 12"</div>
                            <div><strong>XL:</strong> 24" √ó 20" √ó 16"</div>
                        </div>
                    </div>
                </div>

                <!-- Step 3: Schedule -->
                <div class="onboarding-step" data-step="3">
                    <h3>Set Your Fulfillment Schedule</h3>
                    <p>Tell us which days you can drop off orders at lockers.</p>
                    <div class="onboarding-tip">
                        üí° <strong>Tip:</strong> This helps us show customers accurate pickup dates at checkout.
                    </div>
                    <div style="background: var(--p-color-bg-surface-secondary); border-radius: var(--p-border-radius-200); padding: var(--p-space-400); text-align: center;">
                        <p style="margin-bottom: var(--p-space-200);">‚úÖ <strong>Default:</strong> Monday - Friday</p>
                        <p style="color: var(--p-color-text-secondary); font-size: 13px;">You can customize this anytime in the Settings tab</p>
                    </div>
                </div>
            </div>

            <div class="onboarding-footer">
                <span class="skip-link" onclick="skipOnboarding()">Skip for now</span>
                <div class="onboarding-actions">
                    <button class="btn btn-secondary" id="onboarding-back-btn" onclick="onboardingBack()" style="display: none;">Back</button>
                    <button class="btn btn-primary" id="onboarding-next-btn" onclick="onboardingNext()">Next</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Setup Reminder Banner (shown when onboarding was skipped) -->
    <div id="setup-reminder-banner" class="setup-reminder-banner" style="display: none;">
        <p>‚ö†Ô∏è <strong>Setup incomplete:</strong> Select your locker locations to start receiving LockerDrop orders.</p>
        <button class="btn btn-primary btn-small" onclick="reopenOnboarding()">Complete Setup</button>
    </div>

    <script>
        // Get shop from URL
        const urlParams = new URLSearchParams(window.location.search);
        const shop = urlParams.get('shop');

        if (!shop) {
            alert('Shop parameter missing! Please access this page from Shopify.');
        } else {
            document.getElementById('store-name').textContent = shop.replace('.myshopify.com', '');
        }

        // ========== ONBOARDING WIZARD ==========
        let currentOnboardingStep = 1;
        const totalOnboardingSteps = 3;

        // Check if user needs onboarding (no locker preferences saved)
        async function checkOnboardingNeeded() {
            try {
                const response = await fetch(`/api/locker-preferences/${shop}`);
                const preferences = await response.json();

                // Check if user has skipped onboarding before
                const skippedOnboarding = localStorage.getItem(`lockerdrop_onboarding_skipped_${shop}`);

                if (preferences.length === 0) {
                    if (skippedOnboarding) {
                        // Show reminder banner instead of modal
                        showSetupReminderBanner();
                    } else {
                        // Show onboarding modal
                        showOnboardingModal();
                    }
                }
            } catch (error) {
                console.error('Error checking onboarding status:', error);
            }
        }

        function showOnboardingModal() {
            document.getElementById('onboardingModal').style.display = 'block';
            updateOnboardingUI();
        }

        function closeOnboardingModal() {
            document.getElementById('onboardingModal').style.display = 'none';
        }

        function showSetupReminderBanner() {
            const banner = document.getElementById('setup-reminder-banner');
            const container = document.querySelector('.container');
            if (banner && container) {
                // Move banner to start of container
                container.insertBefore(banner, container.firstChild);
                banner.style.display = 'flex';
            }
        }

        function hideSetupReminderBanner() {
            const banner = document.getElementById('setup-reminder-banner');
            if (banner) {
                banner.style.display = 'none';
            }
        }

        function updateOnboardingUI() {
            // Update progress steps
            document.querySelectorAll('.progress-step').forEach(step => {
                const stepNum = parseInt(step.dataset.step);
                step.classList.remove('active', 'completed');
                if (stepNum === currentOnboardingStep) {
                    step.classList.add('active');
                } else if (stepNum < currentOnboardingStep) {
                    step.classList.add('completed');
                }
            });

            // Update step content visibility
            document.querySelectorAll('.onboarding-step').forEach(step => {
                const stepNum = parseInt(step.dataset.step);
                step.classList.toggle('active', stepNum === currentOnboardingStep);
            });

            // Update buttons
            const backBtn = document.getElementById('onboarding-back-btn');
            const nextBtn = document.getElementById('onboarding-next-btn');

            backBtn.style.display = currentOnboardingStep > 1 ? 'inline-block' : 'none';
            nextBtn.textContent = currentOnboardingStep === totalOnboardingSteps ? 'Get Started' : 'Next';
        }

        function onboardingNext() {
            if (currentOnboardingStep < totalOnboardingSteps) {
                currentOnboardingStep++;
                updateOnboardingUI();
            } else {
                // Completed onboarding
                closeOnboardingModal();
                hideSetupReminderBanner();
                localStorage.removeItem(`lockerdrop_onboarding_skipped_${shop}`);
                // Navigate to lockers tab to start setup
                showTab('lockers', document.querySelector('.tab[onclick*="lockers"]'));
            }
        }

        function onboardingBack() {
            if (currentOnboardingStep > 1) {
                currentOnboardingStep--;
                updateOnboardingUI();
            }
        }

        function skipOnboarding() {
            localStorage.setItem(`lockerdrop_onboarding_skipped_${shop}`, 'true');
            closeOnboardingModal();
            showSetupReminderBanner();
        }

        function reopenOnboarding() {
            localStorage.removeItem(`lockerdrop_onboarding_skipped_${shop}`);
            hideSetupReminderBanner();
            currentOnboardingStep = 1;
            showOnboardingModal();
        }

        function goToLockersTab() {
            closeOnboardingModal();
            hideSetupReminderBanner();
            localStorage.removeItem(`lockerdrop_onboarding_skipped_${shop}`);
            showTab('lockers', document.querySelector('.tab[onclick*="lockers"]'));
        }

        // Check onboarding when page loads
        if (shop) {
            setTimeout(() => {
                checkOnboardingNeeded();
            }, 500); // Small delay to let the page initialize
        }

        // Tab Navigation
        function showTab(tabName, clickedTab) {
            const tabs = document.querySelectorAll('.tab');
            const contents = document.querySelectorAll('.tab-content');

            tabs.forEach(tab => tab.classList.remove('active'));
            contents.forEach(content => content.classList.remove('active'));

            if (clickedTab) {
                clickedTab.classList.add('active');
            }
            document.getElementById(tabName).classList.add('active');

            if (tabName === 'lockers') {
                // Initialize map when tab first becomes visible
                setTimeout(() => {
                    initLockerMap();
                    if (lockerMap) lockerMap.invalidateSize(); // Fix map display after tab switch
                }, 100);
                loadLockers();
            }
            if (tabName === 'products') {
                loadProducts();
            }
            if (tabName === 'billing') {
                loadSubscription();
            }
            if (tabName === 'settings') {
                loadBrandingSettings(); // Load branding when settings tab opens
            }
        }

        // Navigate to Orders tab with a specific filter
        function navigateToOrderFilter(status) {
            // Switch to orders tab
            const ordersTab = document.querySelector('.tab[onclick*="orders"]');
            showTab('orders', ordersTab);
            // Apply the filter
            filterOrders(status);
        }

        // Navigate to a specific tab
        function navigateToTab(tabName) {
            const tab = document.querySelector(`.tab[onclick*="${tabName}"]`);
            showTab(tabName, tab);
        }

        // Show only active/saved lockers
        function showActiveLockers() {
            // Navigate to lockers tab
            const tab = document.querySelector('.tab[onclick*="lockers"]');
            showTab('lockers', tab);

            // Use setTimeout to ensure the tab is visible before modifying checkbox
            setTimeout(() => {
                // Enable "My lockers only" filter
                const myLockersCheckbox = document.getElementById('my-lockers-only');
                if (myLockersCheckbox) {
                    myLockersCheckbox.checked = true;
                    // Reset to page 1 and reload with filter
                    lockerCurrentPage = 1;
                    loadLockers(1);
                }
            }, 50);
        }

        // Toggle collapsible sections (legacy - by ID)
        function toggleSection(sectionId) {
            const section = document.getElementById(sectionId);
            const toggle = document.getElementById(sectionId + '-toggle');
            if (section.style.display === 'none') {
                section.style.display = 'block';
                if (toggle) toggle.textContent = '‚àí';
            } else {
                section.style.display = 'none';
                if (toggle) toggle.textContent = '+';
            }
        }

        // Toggle collapsible card sections (by header element)
        function toggleCollapse(headerEl) {
            const content = headerEl.nextElementSibling;
            if (!content || !content.classList.contains('collapsible-content')) return;

            headerEl.classList.toggle('collapsed');
            content.classList.toggle('collapsed');
        }

        // Load Locker Availability (legacy - availability now in My Lockers)
        async function loadAvailability() {
            const container = document.getElementById('availability-container');
            container.innerHTML = '<p style="color: #6d7175;">Loading availability...</p>';

            try {
                const response = await fetch(`/api/locker-availability/${shop}`);
                if (!response.ok) throw new Error('Failed to fetch availability');
                const data = await response.json();
                renderAvailability(data);
            } catch (error) {
                console.error('Error loading availability:', error);
                container.innerHTML = '<p style="color: #bf0711;">Failed to load availability. Please try again.</p>';
            }
        }

        function renderAvailability(data) {
            const container = document.getElementById('availability-container');

            if (data.minAvailableBuffer) {
                document.getElementById('min-buffer').textContent = data.minAvailableBuffer;
            }

            if (!data.locations || data.locations.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #6d7175;">
                        <h3>No Lockers Enabled</h3>
                        <p>Go to "My Lockers" tab to enable locker locations.</p>
                    </div>
                `;
                return;
            }

            let html = `
                <p style="color: #6d7175; font-size: 12px; margin-bottom: 16px;">
                    Last updated: ${new Date(data.fetchedAt).toLocaleString()}
                </p>
            `;

            for (const location of data.locations) {
                const hasError = location.error;
                const utilizationPct = location.totalCapacity > 0
                    ? Math.round(((location.totalCapacity - location.totalAvailable) / location.totalCapacity) * 100)
                    : 0;
                const statusColor = location.totalAvailable >= (data.minAvailableBuffer || 2) ? '#008060' : '#bf0711';

                html += `
                    <div style="border: 1px solid #e1e3e5; border-radius: 8px; padding: 16px; margin-bottom: 16px;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                            <div>
                                <h3 style="margin: 0; font-size: 16px;">${location.name}</h3>
                                <p style="margin: 4px 0 0 0; color: #6d7175; font-size: 13px;">${location.address || ''}</p>
                                <p style="margin: 4px 0 0 0; color: #6d7175; font-size: 11px;">Location ID: ${location.id}</p>
                            </div>
                            <div style="text-align: right;">
                                ${hasError ? `
                                    <span style="color: #bf0711; font-weight: 600;">Error</span>
                                ` : `
                                    <span style="font-size: 24px; font-weight: 600; color: ${statusColor};">${location.totalAvailable}</span>
                                    <span style="color: #6d7175; font-size: 13px;"> / ${location.totalCapacity} available</span>
                                    <p style="margin: 4px 0 0 0; font-size: 12px; color: #6d7175;">${utilizationPct}% in use</p>
                                `}
                            </div>
                        </div>
                `;

                if (!hasError && location.sizeBreakdown && location.sizeBreakdown.length > 0) {
                    html += `
                        <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                            <thead>
                                <tr style="background: #f6f6f7;">
                                    <th style="text-align: left; padding: 8px; border-bottom: 1px solid #e1e3e5;">Size</th>
                                    <th style="text-align: center; padding: 8px; border-bottom: 1px solid #e1e3e5;">Available</th>
                                    <th style="text-align: center; padding: 8px; border-bottom: 1px solid #e1e3e5;">In Use</th>
                                    <th style="text-align: center; padding: 8px; border-bottom: 1px solid #e1e3e5;">Total</th>
                                    <th style="text-align: right; padding: 8px; border-bottom: 1px solid #e1e3e5;">Status</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;

                    for (const size of location.sizeBreakdown) {
                        const sizeStatus = size.available >= (data.minAvailableBuffer || 2) ? 'OK' : 'LOW';
                        const sizeStatusColor = sizeStatus === 'OK' ? '#008060' : '#bf0711';
                        html += `
                            <tr>
                                <td style="padding: 8px; border-bottom: 1px solid #e1e3e5; font-weight: 500;">${size.size}</td>
                                <td style="text-align: center; padding: 8px; border-bottom: 1px solid #e1e3e5; color: ${sizeStatusColor}; font-weight: 600;">${size.available}</td>
                                <td style="text-align: center; padding: 8px; border-bottom: 1px solid #e1e3e5;">${size.inUse}</td>
                                <td style="text-align: center; padding: 8px; border-bottom: 1px solid #e1e3e5;">${size.total}</td>
                                <td style="text-align: right; padding: 8px; border-bottom: 1px solid #e1e3e5;">
                                    <span style="padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: 500; background: ${sizeStatus === 'OK' ? '#e3f5ef' : '#fbeae5'}; color: ${sizeStatusColor};">
                                        ${sizeStatus}
                                    </span>
                                </td>
                            </tr>
                        `;
                    }

                    html += `
                            </tbody>
                        </table>
                    `;
                }

                html += `</div>`;
            }

            container.innerHTML = html;
        }

        function refreshAvailability() {
            loadAvailability();
        }

        // Load Dashboard Stats
        async function loadStats() {
            try {
                const response = await fetch(`/api/stats/${shop}`);
                const stats = await response.json();

                const pendingCount = stats.pendingDropoffs || 0;
                const readyCount = stats.readyForPickup || 0;
                const completedCount = stats.completedThisWeek || 0;
                const lockersCount = stats.activeLockers || 0;
                const futureCount = stats.futureDropoffs || 0;

                // Update stat values
                document.getElementById('stat-pending').textContent = pendingCount;
                document.getElementById('stat-ready').textContent = readyCount;
                document.getElementById('stat-completed').textContent = completedCount;
                document.getElementById('stat-future').textContent = futureCount;

                // Update My Lockers tab with count
                const lockersTab = document.getElementById('tab-lockers');
                if (lockersTab && lockersCount > 0) {
                    lockersTab.textContent = `My Lockers (${lockersCount})`;
                }

                // Update subtexts with actionable copy
                const pendingSubtext = document.getElementById('stat-pending-subtext');
                if (pendingCount > 0) {
                    pendingSubtext.innerHTML = '<span class="warning">‚è∞ Drop off by EOD today</span>';
                } else {
                    pendingSubtext.innerHTML = '<span class="success">‚úÖ All caught up!</span>';
                }

                const readySubtext = document.getElementById('stat-ready-subtext');
                if (readyCount > 0) {
                    readySubtext.innerHTML = 'üì¨ Customers notified';
                } else {
                    readySubtext.innerHTML = '';
                }

                const completedSubtext = document.getElementById('stat-completed-subtext');
                if (completedCount > 0) {
                    const savings = completedCount * 8; // $8 avg shipping cost
                    completedSubtext.innerHTML = `<span class="success">üí∞ Saved ~$${savings} in shipping</span>`;
                } else {
                    completedSubtext.innerHTML = '';
                }

                const futureSubtext = document.getElementById('stat-future-subtext');
                if (futureCount > 0) {
                    futureSubtext.innerHTML = `<span class="info">üìÖ ${futureCount} scheduled</span>`;
                } else {
                    futureSubtext.innerHTML = 'No future orders';
                }

                // Update priority banner
                updatePriorityBanner(pendingCount, stats.nextDropoffLocation);
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // Update the priority action banner
        function updatePriorityBanner(pendingCount, nextLocation) {
            const banner = document.getElementById('priority-banner');
            const message = document.getElementById('priority-message');
            const directionsBtn = document.getElementById('priority-directions-btn');

            if (pendingCount > 0) {
                banner.style.display = 'block';

                if (nextLocation && nextLocation.name) {
                    message.textContent = `Drop off ${pendingCount} order${pendingCount > 1 ? 's' : ''} at ${nextLocation.name}`;

                    // Show directions button if we have address
                    if (nextLocation.address) {
                        const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(nextLocation.address)}`;
                        directionsBtn.href = mapsUrl;
                        directionsBtn.style.display = 'inline-flex';
                    } else {
                        directionsBtn.style.display = 'none';
                    }
                } else {
                    message.textContent = `Drop off ${pendingCount} order${pendingCount > 1 ? 's' : ''} today`;
                    directionsBtn.style.display = 'none';
                }
            } else {
                banner.style.display = 'none';
            }
        }

        // Store all orders for filtering
        let allOrders = [];
        let currentFilter = 'active'; // Default filter
        let currentSort = { column: 'date', direction: 'desc' }; // Default sort by date descending

        // Sort orders
        function sortOrders(column) {
            // Toggle direction if same column, otherwise default to descending
            if (currentSort.column === column) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = column;
                currentSort.direction = 'desc';
            }

            // Update header classes
            document.querySelectorAll('.orders-table th.sortable').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
                if (th.dataset.sort === column) {
                    th.classList.add(currentSort.direction === 'asc' ? 'sort-asc' : 'sort-desc');
                }
            });

            renderOrders();
        }

        // Load All Orders
        async function loadOrders() {
            try {
                const response = await fetch(`/api/orders/${shop}`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                const data = await response.json();
                allOrders = Array.isArray(data) ? data : [];
                renderOrders();
            } catch (error) {
                console.error('Error loading orders:', error);
                allOrders = [];
                renderOrders();
            }
        }

        // Filter orders
        function filterOrders(status) {
            currentFilter = status;

            // Update filter button styles
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.status === status) {
                    btn.classList.add('active');
                }
            });

            renderOrders();
        }

        // Render orders based on current filter
        function renderOrders() {
            const tbody = document.getElementById('orders-table-body');

            let filteredOrders = allOrders;

            if (currentFilter === 'active') {
                // Active = pending_dropoff + ready_for_pickup (excludes completed and cancelled)
                filteredOrders = allOrders.filter(o => o.status !== 'completed' && o.status !== 'cancelled');
            } else if (currentFilter === 'future_dropoff') {
                // Future drop-off = pending_dropoff with pickup date in the future
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                filteredOrders = allOrders.filter(o => {
                    if (o.status !== 'pending_dropoff' || !o.pickupDate) return false;
                    const pickupDate = new Date(o.pickupDate + 'T00:00:00');
                    return pickupDate > today;
                });
            } else if (currentFilter !== 'all') {
                filteredOrders = allOrders.filter(o => o.status === currentFilter);
            }

            // Apply sorting
            filteredOrders = [...filteredOrders].sort((a, b) => {
                let aVal = a[currentSort.column];
                let bVal = b[currentSort.column];

                // Handle special cases
                if (currentSort.column === 'orderNumber') {
                    aVal = parseInt(aVal) || 0;
                    bVal = parseInt(bVal) || 0;
                } else if (currentSort.column === 'date' || currentSort.column === 'pickupDate') {
                    aVal = aVal ? new Date(aVal) : new Date(0);
                    bVal = bVal ? new Date(bVal) : new Date(0);
                } else {
                    aVal = (aVal || '').toString().toLowerCase();
                    bVal = (bVal || '').toString().toLowerCase();
                }

                if (aVal < bVal) return currentSort.direction === 'asc' ? -1 : 1;
                if (aVal > bVal) return currentSort.direction === 'asc' ? 1 : -1;
                return 0;
            });

            if (filteredOrders.length === 0) {
                let message, subtext, actionHtml = '';
                if (currentFilter === 'active') {
                    message = 'üì≠ No active orders';
                    subtext = 'Orders will appear here when customers choose LockerDrop at checkout.';
                    actionHtml = `<button class="btn btn-secondary btn-small" onclick="showTab('learn', document.querySelector('.tab[onclick*=\\'learn\\']'))" style="margin-top: 12px;">View Quick Start Guide</button>`;
                } else if (currentFilter === 'all') {
                    message = 'üì≠ No orders yet';
                    subtext = 'Once customers select locker pickup at checkout, their orders will appear here.';
                    actionHtml = savedPreferenceIds.length === 0
                        ? `<button class="btn btn-primary btn-small" onclick="showTab('lockers', document.querySelector('.tab[onclick*=\\'lockers\\']'))" style="margin-top: 12px;">Select Your Lockers</button>`
                        : `<button class="btn btn-secondary btn-small" onclick="showTab('learn', document.querySelector('.tab[onclick*=\\'learn\\']'))" style="margin-top: 12px;">View Quick Start Guide</button>`;
                } else if (currentFilter === 'pending_dropoff') {
                    message = 'üéâ All caught up!';
                    subtext = 'No orders waiting for drop-off. Great job staying on top of things!';
                } else if (currentFilter === 'future_dropoff') {
                    message = 'üìÖ No future drop-offs';
                    subtext = 'Orders with pickup dates in the future will appear here.';
                } else if (currentFilter === 'ready_for_pickup') {
                    message = 'üì¶ No orders in lockers';
                    subtext = 'Orders appear here after you drop them off. Customers will be notified automatically.';
                } else if (currentFilter === 'completed') {
                    message = 'üìä No completed orders yet';
                    subtext = 'Completed orders will appear here once customers pick up their items.';
                } else if (currentFilter === 'cancelled') {
                    message = '‚úì No cancelled orders';
                    subtext = 'Cancelled orders will appear here if any orders are cancelled.';
                } else {
                    message = `No ${formatStatus(currentFilter).toLowerCase()} orders`;
                    subtext = '';
                }
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="empty-state">
                            <h3>${message}</h3>
                            ${subtext ? `<p style="color: #6d7175; margin-top: 8px;">${subtext}</p>` : ''}
                            ${actionHtml}
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = filteredOrders.map(order => `
                <tr>
                    <td data-label="Order"><strong>#${order.orderNumber}</strong></td>
                    <td data-label="Date">${order.date}</td>
                    <td data-label="Pickup Date">${order.pickupDate ? formatPickupDate(order.pickupDate) : '<span style="color: #6d7175;">-</span>'}</td>
                    <td data-label="Customer">${order.customerName}</td>
                    <td data-label="Locker">${order.lockerName || 'Not assigned'}</td>
                    <td data-label="Drop-off">${order.dropoffLink ? `<a href="${order.dropoffLink}" target="_blank" class="btn btn-secondary btn-small">${order.status === 'pending_dropoff' ? 'Open' : 'Used'}</a>` : '<span style="color: #6d7175;">-</span>'}</td>
                    <td data-label="Pickup">${order.pickupLink ? `<a href="${order.pickupLink}" target="_blank" class="btn btn-secondary btn-small">${order.status === 'ready_for_pickup' ? 'Open' : 'Used'}</a>` : '<span style="color: #6d7175;">-</span>'}</td>
                    <td data-label="Status"><span class="status-badge status-${order.status}">${formatStatus(order.status, order.completedAt)}</span></td>
                    <td>
                        <button class="btn btn-primary btn-small" onclick="viewOrder('${order.orderNumber}')">View</button>
                    </td>
                </tr>
            `).join('');
        }

        function formatStatus(status, completedAt = null) {
            if (status === 'completed' && completedAt) {
                const date = new Date(completedAt);
                const formatted = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                return `‚úì Picked up ${formatted}`;
            }
            const statusMap = {
                'pending_dropoff': '‚è≥ Waiting for drop-off',
                'future_dropoff': 'üìÖ Future drop-off',
                'ready_for_pickup': 'üì¶ In locker - notified',
                'completed': '‚úì Picked up',
                'cancelled': '‚úó Cancelled'
            };
            return statusMap[status] || status;
        }

        function formatPickupDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr + 'T00:00:00');
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);

            if (date.getTime() === today.getTime()) {
                return '<span style="color: #d97706; font-weight: 600;">Today</span>';
            } else if (date.getTime() === tomorrow.getTime()) {
                return '<span style="color: #059669;">Tomorrow</span>';
            } else if (date < today) {
                return '<span style="color: #6d7175;">' + date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + '</span>';
            } else {
                return '<span style="color: #059669;">' + date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' }) + '</span>';
            }
        }

        // View Order Modal
        async function viewOrder(orderNumber) {
            try {
                const response = await fetch(`/api/orders/${shop}`);
                const orders = await response.json();

                const order = orders.find(o => o.orderNumber === orderNumber);

                if (!order) {
                    alert('Order not found');
                    return;
                }

                document.getElementById('modal-order-number').textContent = '#' + order.orderNumber;
                document.getElementById('modal-customer').textContent = order.customerName;
                document.getElementById('modal-email').textContent = order.customerEmail || 'Not provided';
                document.getElementById('modal-phone').textContent = order.customerPhone || 'Not provided';
                document.getElementById('modal-locker').textContent = order.lockerName || 'Not assigned';
                document.getElementById('modal-status').textContent = formatStatus(order.status, order.completedAt);

                // Dropoff link section
                const dropoffContent = document.getElementById('dropoff-content');
                const dropoffPending = order.status === 'pending_dropoff';
                if (order.dropoffLink) {
                    dropoffContent.innerHTML = `
                        <p style="color: var(--p-color-text-secondary); font-size: 13px; margin-bottom: 12px;">
                            Open this link <strong>at the locker</strong> to unlock it and drop off the package.
                        </p>
                        <a href="${order.dropoffLink}" target="_blank" class="btn btn-primary">
                            üîì Open Locker Link
                        </a>
                        ${dropoffPending ? `
                        <button class="btn btn-secondary btn-small" onclick="regenerateDropoffLink('${order.orderNumber}')" style="margin-left: 8px;" title="Regenerate if link expired">
                            üîÑ Regenerate
                        </button>
                        <div style="margin-top: 12px; padding: 10px; background: #f0fdf4; border-radius: 6px; font-size: 12px; color: #065f46;">
                            üí° <strong>Tip:</strong> Save this link - you can reopen it if the door closes before you're done.
                        </div>
                        ` : '<span style="color: #008060; margin-left: 8px;">‚úì Used</span>'}
                    `;
                } else {
                    dropoffContent.innerHTML = `
                        <p style="color: #6d7175; margin-bottom: 8px;">Not generated yet.</p>
                        <button class="btn btn-primary btn-small" onclick="regenerateDropoffLink('${order.orderNumber}')">
                            üîó Generate Dropoff Link
                        </button>
                    `;
                }

                // Pickup link section
                const pickupContent = document.getElementById('pickup-content');
                const canRegenPickup = order.status === 'ready_for_pickup' || order.status === 'dropped_off';
                if (order.pickupLink) {
                    pickupContent.innerHTML = `
                        <a href="${order.pickupLink}" target="_blank" class="btn btn-secondary">
                            üîì Customer Pickup Link
                        </a>
                        ${canRegenPickup ? `
                        <button class="btn btn-secondary btn-small" onclick="regeneratePickupLink('${order.orderNumber}')" style="margin-left: 8px;" title="Regenerate if link expired">
                            üîÑ Regenerate
                        </button>
                        <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e1e3e5;">
                            <p style="color: #6d7175; font-size: 13px; margin-bottom: 8px;">Resend notification to customer:</p>
                            <button class="btn btn-small" onclick="resendNotification('${order.orderNumber}', 'sms')" style="margin-right: 6px;">üì± Send SMS</button>
                            <button class="btn btn-small" onclick="resendNotification('${order.orderNumber}', 'email')" style="margin-right: 6px;">üìß Send Email</button>
                            <button class="btn btn-small" onclick="resendNotification('${order.orderNumber}', 'both')">üì±üìß Send Both</button>
                        </div>
                        ` : '<span style="color: #008060; margin-left: 8px;">‚úì Picked up</span>'}
                    `;
                } else {
                    pickupContent.innerHTML = `<p style="color: #6d7175;">Will be generated after drop-off</p>`;
                }

                // Show/hide mark as dropped off button based on status
                const btnMarkDropped = document.getElementById('btn-mark-dropped');
                if (order.status === 'pending_dropoff') {
                    btnMarkDropped.style.display = 'inline-block';
                } else {
                    btnMarkDropped.style.display = 'none';
                }

                document.getElementById('orderModal').style.display = 'block';
            } catch (error) {
                console.error('Error loading order:', error);
                alert('Failed to load order details');
            }
        }

        function closeModal() {
            document.getElementById('orderModal').style.display = 'none';
        }

        // Resend notification to customer
        async function resendNotification(orderNumber, type) {
            const typeLabel = type === 'both' ? 'SMS and Email' : type === 'sms' ? 'SMS' : 'Email';
            if (!confirm(`Resend ${typeLabel} notification for order #${orderNumber}?`)) return;

            try {
                const response = await fetch(`/api/resend-notification/${orderNumber}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type })
                });

                const result = await response.json();

                if (result.success) {
                    let message = 'Notification sent!';
                    if (result.emailSent && result.smsSent) {
                        message = 'Email and SMS sent successfully!';
                    } else if (result.emailSent) {
                        message = 'Email sent successfully!';
                    } else if (result.smsSent) {
                        message = 'SMS sent successfully!';
                    }
                    alert(message);
                } else {
                    alert('Failed: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error resending notification:', error);
                alert('Error sending notification');
            }
        }

        // Regenerate pickup link - for when customer's link has expired
        async function regeneratePickupLink(orderNumber) {
            if (!confirm(`Regenerate pickup link for order #${orderNumber}?\n\nUse this if the current link shows an error or has expired.`)) return;

            try {
                const response = await fetch(`/api/emergency-open/${shop}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        orderNumber: orderNumber,
                        reason: 'Link regeneration requested',
                        openType: 'pickup'
                    })
                });

                const result = await response.json();

                if (result.success) {
                    alert(`‚úÖ New pickup link generated for order #${orderNumber}!\n\nThe page will refresh to show the new link.`);
                    closeModal();
                    loadOrders();
                } else {
                    alert(`Failed to regenerate link:\n\n${result.error || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Error regenerating pickup link:', error);
                alert('Error: Failed to regenerate link. Please try again.');
            }
        }

        // Regenerate dropoff link for an order (when link has expired)
        async function regenerateDropoffLink(orderNumber) {
            if (!confirm(`Regenerate dropoff link for order #${orderNumber}?\n\nUse this if the current link shows a 502 error or has expired.`)) return;

            try {
                const btn = event.target;
                const originalText = btn.innerHTML;
                btn.innerHTML = '‚è≥ Regenerating...';
                btn.disabled = true;

                const response = await fetch(`/api/regenerate-order-link/${shop}/${orderNumber}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const result = await response.json();

                if (result.success) {
                    alert(`New dropoff link generated for order #${orderNumber}!\n\nThe page will refresh to show the new link.`);
                    // Refresh the orders and reopen the modal
                    await loadOrders();
                    viewOrder(orderNumber);
                } else {
                    alert('Failed to regenerate link: ' + (result.details || result.error || 'Unknown error'));
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            } catch (error) {
                console.error('Error regenerating dropoff link:', error);
                alert('Error regenerating link. Please try again.');
            }
        }

        // Sync Orders from Shopify
        async function syncOrders() {
            if (!confirm('Sync all LockerDrop orders from Shopify?')) return;

            try {
                const response = await fetch(`/api/sync-orders/${shop}`);
                const result = await response.json();

                if (result.success) {
                    alert(`Synced ${result.synced} new orders!`);
                    loadOrders();
                    loadStats();
                } else {
                    alert('Failed to sync: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error syncing:', error);
                alert('Error syncing orders');
            }
        }

        // Mark as Dropped Off
        async function markAsDroppedOff() {
            const orderId = document.getElementById('modal-order-number').textContent;
            const encodedOrderId = encodeURIComponent(orderId);

            try {
                const response = await fetch(`/api/order/${shop}/${encodedOrderId}/status`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: 'ready' })
                });

                const result = await response.json();

                if (result.success) {
                    alert('Order marked as dropped off! Customer will be notified.');
                    closeModal();
                    loadStats();
                    loadOrders();
                } else {
                    alert('Failed to update order: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error updating order:', error);
                alert('Failed to update order status: ' + error.message);
            }
        }

        // Resend Customer Email
        async function resendCustomerEmail() {
            const orderId = document.getElementById('modal-order-number').textContent;
            const encodedOrderId = encodeURIComponent(orderId);

            try {
                const response = await fetch(`/api/order/${shop}/${encodedOrderId}/resend-email`, {
                    method: 'POST'
                });

                const result = await response.json();

                if (result.success) {
                    alert('Pickup email resent to customer!');
                } else {
                    alert('Failed to resend: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error resending email:', error);
                alert('Failed to resend email');
            }
        }

        async function cancelLockerRequest() {
            const orderId = document.getElementById('modal-order-number').textContent;

            if (!confirm(`Are you sure you want to cancel the locker for order ${orderId}? This will release the locker reservation.`)) {
                return;
            }

            const encodedOrderId = encodeURIComponent(orderId);

            try {
                const response = await fetch(`/api/order/${shop}/${encodedOrderId}/cancel-locker`, {
                    method: 'POST'
                });

                const result = await response.json();

                if (result.success) {
                    alert('Locker request cancelled successfully');
                    closeModal();
                    loadOrders(); // Refresh the orders list
                } else {
                    alert('Failed to cancel: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error cancelling locker:', error);
                alert('Failed to cancel locker request');
            }
        }

        // Locker search state
        let lockerCurrentPage = 1;
        let lockerTotalPages = 1;
        let lockerTotalCount = 0;
        let savedPreferenceIds = [];
        let originalSavedIds = []; // Track original state to detect changes
        let lockerMap = null;
        let lockerMarkers = [];
        let allLockersForMap = []; // Store all lockers for map display

        // Initialize the locker map
        function initLockerMap() {
            if (lockerMap) return; // Already initialized

            lockerMap = L.map('locker-map').setView([39.8283, -98.5795], 4); // Center of USA

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 18
            }).addTo(lockerMap);
        }

        // Update map with locker markers
        function updateLockerMap(lockers) {
            if (!lockerMap) initLockerMap();

            // Clear existing markers
            lockerMarkers.forEach(marker => lockerMap.removeLayer(marker));
            lockerMarkers = [];

            // We need geocoded locations - for now use placeholder positions
            // In production, you'd have lat/lng from the Harbor API
            const bounds = [];

            lockers.forEach((locker, index) => {
                // Try to get coordinates from locker data, or skip if not available
                if (locker.latitude && locker.longitude) {
                    const isSelected = savedPreferenceIds.includes(locker.id.toString());
                    const markerColor = isSelected ? '#008060' : '#5c6ac4';

                    const icon = L.divIcon({
                        className: 'locker-map-marker-wrapper',
                        html: `<div style="width: 12px; height: 12px; background: ${markerColor}; border: 2px solid white; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>`,
                        iconSize: [16, 16],
                        iconAnchor: [8, 8]
                    });

                    const marker = L.marker([locker.latitude, locker.longitude], { icon })
                        .addTo(lockerMap)
                        .bindPopup(`
                            <strong>${locker.name}</strong>
                            ${locker.address}<br>
                            <em>${isSelected ? '‚úì Selected' : 'Click list to select'}</em>
                        `);

                    marker.on('click', () => {
                        // Scroll to and highlight this locker in the list
                        const lockerEl = document.querySelector(`[data-location-id="${locker.id}"]`);
                        if (lockerEl) {
                            lockerEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            lockerEl.style.boxShadow = '0 0 0 2px #008060';
                            setTimeout(() => lockerEl.style.boxShadow = '', 2000);
                        }
                    });

                    lockerMarkers.push(marker);
                    bounds.push([locker.latitude, locker.longitude]);
                }
            });

            // Fit map to show all markers
            if (bounds.length > 0) {
                lockerMap.fitBounds(bounds, { padding: [20, 20], maxZoom: 12 });
            }
        }

        // Check if there are unsaved changes
        function hasLockerChanges() {
            const currentIds = [...savedPreferenceIds].sort();
            const originalIds = [...originalSavedIds].sort();

            if (currentIds.length !== originalIds.length) return true;
            return currentIds.some((id, i) => id !== originalIds[i]);
        }

        // Update Save button state
        function updateSaveButtonState() {
            const btn = document.getElementById('save-lockers-btn');
            const hasChanges = hasLockerChanges();

            btn.disabled = !hasChanges;
            btn.style.opacity = hasChanges ? '1' : '0.5';
            btn.textContent = hasChanges ? 'Save Changes' : 'No Changes';
        }

        // Load Lockers with search, filters, and pagination
        async function loadLockers(page = 1) {
            const lockerList = document.getElementById('locker-list');
            const paginationEl = document.getElementById('locker-pagination');

            // Show skeleton loading
            lockerList.innerHTML = Array(5).fill(0).map(() => `
                <div class="skeleton-locker">
                    <div class="skeleton skeleton-checkbox"></div>
                    <div class="skeleton-locker-info">
                        <div class="skeleton skeleton-text medium"></div>
                        <div class="skeleton skeleton-text short"></div>
                    </div>
                    <div style="display: flex; gap: 4px;">
                        <div class="skeleton" style="width: 24px; height: 20px;"></div>
                        <div class="skeleton" style="width: 24px; height: 20px;"></div>
                        <div class="skeleton" style="width: 24px; height: 20px;"></div>
                    </div>
                </div>
            `).join('');

            try {
                // Build query params
                const searchValue = document.getElementById('locker-search').value.trim();
                const showAvailability = document.getElementById('show-availability').checked;
                const selectedSizes = Array.from(document.querySelectorAll('.size-filter:checked'))
                    .map(cb => cb.value);
                const myLockersOnly = document.getElementById('my-lockers-only')?.checked;

                // Load saved preferences first if needed (so we know IDs for filtering)
                if (savedPreferenceIds.length === 0 || originalSavedIds.length === 0) {
                    const prefsResponse = await fetch(`/api/locker-preferences/${shop}`);
                    const preferences = await prefsResponse.json();
                    savedPreferenceIds = preferences.map(p => p.location_id.toString());
                    // Store original state for change detection
                    originalSavedIds = [...savedPreferenceIds];
                    updateSaveButtonState();
                }

                // Build URL - use saved_only param for efficient server-side filtering
                let url = `/api/lockers/${shop}?page=${page}&limit=20`;
                if (searchValue) url += `&search=${encodeURIComponent(searchValue)}`;
                // Include availability if checkbox is checked OR if size filters are selected (required for filtering)
                if (showAvailability || selectedSizes.length > 0) url += `&includeAvailability=true`;
                if (selectedSizes.length > 0) url += `&sizes=${selectedSizes.join(',')}`;
                // Use server-side filtering for "My lockers only" (much faster than fetching 1000)
                if (myLockersOnly) url += `&saved_only=true`;

                // Load available lockers
                const response = await fetch(url);
                const data = await response.json();

                // Handle both old format (array) and new format (object with lockers and pagination)
                let lockers = Array.isArray(data) ? data : data.lockers;
                const pagination = data.pagination || { page: 1, totalCount: lockers.length, totalPages: 1 };

                // Server handles filtering via saved_only param, just use the results
                let filteredLockers = lockers;
                lockerCurrentPage = pagination.page;
                lockerTotalPages = pagination.totalPages;
                lockerTotalCount = pagination.totalCount;

                if (filteredLockers.length === 0) {
                    lockerList.innerHTML = myLockersOnly
                        ? `<div class="empty-state" style="padding: 40px 20px;">
                            <h3>No active lockers</h3>
                            <p style="color: #6d7175; margin-top: 8px;">You haven't selected any lockers yet. Uncheck "My lockers only" to browse available locations.</p>
                            <button class="btn btn-secondary" onclick="document.getElementById('my-lockers-only').checked = false; searchLockers();" style="margin-top: 16px;">Show All Lockers</button>
                           </div>`
                        : searchValue
                        ? `<div class="empty-state" style="padding: 40px 20px;">
                            <h3>No lockers found</h3>
                            <p style="color: #6d7175; margin-top: 8px;">Try a different city or zip code, or clear your filters.</p>
                            <button class="btn btn-secondary" onclick="clearLockerSearch()" style="margin-top: 16px;">Clear Search</button>
                           </div>`
                        : `<div class="empty-state" style="padding: 40px 20px;">
                            <h3>No lockers available yet</h3>
                            <p style="color: #6d7175; margin-top: 8px;">Locker locations will appear here once they become available in your area.</p>
                           </div>`;
                    paginationEl.style.display = 'none';
                    return;
                }

                lockerList.innerHTML = filteredLockers.map(locker => {
                    const isSelected = savedPreferenceIds.includes(locker.id.toString());
                    const locationText = [locker.city, locker.state, locker.zip].filter(Boolean).join(', ');
                    const fullAddress = locker.address ? (locationText ? `${locker.address}, ${locationText}` : locker.address) : locationText;

                    return `
                    <div class="locker-item ${isSelected ? 'selected' : ''}"
                         onclick="toggleLocker(this)"
                         data-location-id="${locker.id}">
                        <div class="locker-checkbox">
                            <svg width="12" height="12" viewBox="0 0 12 12" fill="white"><path d="M10 3L4.5 8.5L2 6" stroke="white" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>
                        </div>
                        <div class="locker-info">
                            <div class="locker-name">${locker.name || 'Locker'}</div>
                            <div class="locker-address">${fullAddress || 'Address not available'}</div>
                        </div>
                        ${locker.availability ? `
                            <div class="locker-sizes">
                                ${Object.entries(locker.availability).map(([size, data]) => {
                                    const sizeLabel = size.toLowerCase().includes('x-large') || size.toLowerCase() === 'xlarge' ? 'XL'
                                        : size[0].toUpperCase();
                                    return `
                                    <span class="size-badge" style="background: ${data.available > 0 ? '#e3f9e5' : '#fce8e8'}; color: ${data.available > 0 ? '#108043' : '#bf0711'};">
                                        ${sizeLabel}: ${data.available}
                                    </span>
                                `}).join('')}
                            </div>
                        ` : `
                            <div class="locker-sizes">
                                ${(locker.available_sizes || ['S', 'M', 'L', 'XL']).map(size => {
                                    const label = size.toLowerCase().includes('x-large') || size.toLowerCase() === 'xlarge' ? 'XL'
                                        : size.length <= 2 ? size : size[0].toUpperCase();
                                    return `<span class="size-badge">${label}</span>`;
                                }).join('')}
                            </div>
                        `}
                    </div>
                `}).join('');

                // Update pagination UI
                if (lockerTotalPages > 1) {
                    paginationEl.style.display = 'block';
                    const start = (lockerCurrentPage - 1) * 20 + 1;
                    const end = Math.min(lockerCurrentPage * 20, lockerTotalCount);
                    document.getElementById('locker-page-info').textContent = `Showing ${start}-${end} of ${lockerTotalCount} lockers`;
                    document.getElementById('prev-page-btn').disabled = lockerCurrentPage <= 1;
                    document.getElementById('next-page-btn').disabled = lockerCurrentPage >= lockerTotalPages;
                } else {
                    paginationEl.style.display = lockerTotalCount > 0 ? 'block' : 'none';
                    if (lockerTotalCount > 0) {
                        document.getElementById('locker-page-info').textContent = `Showing ${lockerTotalCount} locker${lockerTotalCount !== 1 ? 's' : ''}`;
                        document.getElementById('prev-page-btn').disabled = true;
                        document.getElementById('next-page-btn').disabled = true;
                    }
                }

                // Update selection counter
                updateLockerSelectionCount();

                // Update map with locker locations
                updateLockerMap(filteredLockers);
            } catch (error) {
                console.error('Error loading lockers:', error);
                lockerList.innerHTML = `<p style="color: #bf0711;">Error loading lockers. Please try again.</p>`;
            }
        }

        function searchLockers() {
            lockerCurrentPage = 1;
            loadLockers(1);
        }

        function clearLockerSearch() {
            document.getElementById('locker-search').value = '';
            document.querySelectorAll('.size-filter').forEach(cb => cb.checked = false);
            document.getElementById('show-availability').checked = false;
            lockerCurrentPage = 1;
            loadLockers(1);
        }

        function prevLockerPage() {
            if (lockerCurrentPage > 1) {
                loadLockers(lockerCurrentPage - 1);
            }
        }

        function nextLockerPage() {
            if (lockerCurrentPage < lockerTotalPages) {
                loadLockers(lockerCurrentPage + 1);
            }
        }

        function toggleLocker(card) {
            const lockerId = card.dataset.locationId.toString();
            card.classList.toggle('selected');

            // Update savedPreferenceIds to track total selections
            if (card.classList.contains('selected')) {
                if (!savedPreferenceIds.includes(lockerId)) {
                    savedPreferenceIds.push(lockerId);
                }
            } else {
                savedPreferenceIds = savedPreferenceIds.filter(id => id !== lockerId);
            }

            updateLockerSelectionCount();
            updateSaveButtonState();
        }

        function updateLockerSelectionCount() {
            // Use savedPreferenceIds for total count (not just visible cards)
            const count = savedPreferenceIds.length;
            const countEl = document.getElementById('locker-selection-count');
            if (countEl) {
                countEl.textContent = count === 1 ? '1 locker selected' : `${count} lockers selected`;
                countEl.style.color = count > 0 ? '#008060' : '#6d7175';
            }
        }

        // Save Locker Preferences
        async function saveLockerPreferences() {
            const selectedLockers = [];
            document.querySelectorAll('.locker-item.selected').forEach(card => {
                selectedLockers.push({
                    id: card.dataset.locationId,
                    name: card.querySelector('.locker-name').textContent
                });
            });

            // Also include any saved preferences that aren't visible on current page
            savedPreferenceIds.forEach(id => {
                if (!selectedLockers.find(l => l.id === id)) {
                    // This locker is saved but not on current page, keep it
                    selectedLockers.push({ id: id, name: '' });
                }
            });

            if (selectedLockers.length === 0) {
                const confirmed = confirm(
                    '‚ö†Ô∏è No lockers selected!\n\n' +
                    'Customers won\'t see LockerDrop as a shipping option at checkout if you have no lockers enabled.\n\n' +
                    'Are you sure you want to continue with no lockers?'
                );
                if (!confirmed) return;
            }

            const btn = document.getElementById('save-lockers-btn');
            const originalText = btn.textContent;
            btn.classList.add('btn-loading');
            btn.textContent = 'Saving...';

            try {
                const response = await fetch(`/api/locker-preferences/${shop}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ selectedLockers })
                });

                const data = await response.json();
                if (data.success) {
                    const count = selectedLockers.length;
                    btn.textContent = `‚úì ${count} locker${count !== 1 ? 's' : ''} saved`;
                    btn.style.background = '#008060';

                    // Update original state to match current (no more pending changes)
                    originalSavedIds = [...savedPreferenceIds];

                    setTimeout(() => {
                        btn.textContent = 'No Changes';
                        btn.style.background = '';
                        btn.disabled = true;
                        btn.style.opacity = '0.5';
                    }, 2500);
                    // Also hide reminder banner if it was showing
                    hideSetupReminderBanner();
                } else {
                    alert('Failed to save preferences');
                    btn.textContent = originalText;
                }
                loadStats();
            } catch (error) {
                console.error('Error:', error);
                alert('Error saving preferences');
                btn.textContent = originalText;
            } finally {
                btn.classList.remove('btn-loading');
            }
        }

        // Store vacation days in memory
        let vacationDays = [];

        // Auto-save debounce timer
        let autoSaveTimer = null;

        // Auto-save Settings (debounced)
        function autoSaveSettings() {
            // Clear any pending save
            if (autoSaveTimer) clearTimeout(autoSaveTimer);

            // Debounce: wait 500ms before saving
            autoSaveTimer = setTimeout(async () => {
                await saveSettingsQuiet();
            }, 500);
        }

        // Save Settings quietly (no alerts, shows status banner)
        async function saveSettingsQuiet() {
            try {
                const freePickup = document.getElementById('free-pickup').checked;
                const useCheckoutExtension = document.getElementById('use-checkout-extension').checked;
                const processingDays = parseInt(document.getElementById('processing-days').value) || 1;
                const holdTimeDays = parseInt(document.getElementById('hold-time').value) || 5;

                // Get selected fulfillment days
                const fulfillmentDays = Array.from(document.querySelectorAll('.fulfillment-day:checked'))
                    .map(cb => cb.value);

                if (fulfillmentDays.length === 0) {
                    return; // Don't save if no days selected
                }

                // Update pricing display
                updatePricingDisplay(freePickup);

                const response = await fetch(`/api/settings/${shop}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        freePickup,
                        useCheckoutExtension,
                        processingDays,
                        holdTimeDays,
                        fulfillmentDays,
                        vacationDays
                    })
                });

                const data = await response.json();
                if (data.success) {
                    // Show saved status
                    const statusEl = document.getElementById('settings-save-status');
                    if (statusEl) {
                        statusEl.style.display = 'block';
                        // Hide after 3 seconds
                        setTimeout(() => {
                            statusEl.style.display = 'none';
                        }, 3000);
                    }
                }
            } catch (error) {
                console.error('Error saving settings:', error);
            }
        }

        // Save Settings (with alerts - for manual save button if needed)
        async function saveSettings() {
            try {
                const freePickup = document.getElementById('free-pickup').checked;
                const useCheckoutExtension = document.getElementById('use-checkout-extension').checked;
                const processingDays = parseInt(document.getElementById('processing-days').value) || 1;
                const holdTimeDays = parseInt(document.getElementById('hold-time').value) || 5;

                // Get selected fulfillment days
                const fulfillmentDays = Array.from(document.querySelectorAll('.fulfillment-day:checked'))
                    .map(cb => cb.value);

                if (fulfillmentDays.length === 0) {
                    alert('Please select at least one fulfillment day');
                    return;
                }

                const response = await fetch(`/api/settings/${shop}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        freePickup,
                        useCheckoutExtension,
                        processingDays,
                        holdTimeDays,
                        fulfillmentDays,
                        vacationDays
                    })
                });

                const data = await response.json();
                if (data.success) {
                    // Show saved status instead of alert
                    const statusEl = document.getElementById('settings-save-status');
                    if (statusEl) {
                        statusEl.style.display = 'block';
                        setTimeout(() => {
                            statusEl.style.display = 'none';
                        }, 3000);
                    }
                } else {
                    alert('Failed to save settings');
                }
            } catch (error) {
                console.error('Error saving settings:', error);
                alert('Error saving settings');
            }
        }

        // Load Settings
        async function loadSettings() {
            try {
                const response = await fetch(`/api/settings/${shop}`);
                const data = await response.json();

                // Checkout extension
                document.getElementById('use-checkout-extension').checked = data.useCheckoutExtension || false;

                // Free pickup
                const checkbox = document.getElementById('free-pickup');
                checkbox.checked = data.freePickup || false;
                updatePricingDisplay(data.freePickup);

                // Processing days
                document.getElementById('processing-days').value = data.processingDays || 1;

                // Hold time
                document.getElementById('hold-time').value = data.holdTimeDays || 5;

                // Fulfillment days
                const days = data.fulfillmentDays || ['monday','tuesday','wednesday','thursday','friday'];
                document.querySelectorAll('.fulfillment-day').forEach(cb => {
                    cb.checked = days.includes(cb.value);
                });

                // Vacation days
                vacationDays = (data.vacationDays || []).map(d => d.split('T')[0]);
                renderVacationDays();

                // Update pickup preview
                updatePickupPreview();
            } catch (error) {
                console.error('Error loading settings:', error);
            }
        }

        // Update vacation button text based on selected dates
        function updateVacationButtonText() {
            const startDate = document.getElementById('vacation-start-date').value;
            const endDate = document.getElementById('vacation-end-date').value;
            const btn = document.getElementById('add-vacation-btn');

            if (startDate && endDate && startDate !== endDate) {
                const start = new Date(startDate);
                const end = new Date(endDate);
                const days = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
                btn.textContent = `Add ${days} Days`;
            } else if (startDate || endDate) {
                btn.textContent = 'Add Day';
            } else {
                btn.textContent = 'Add';
            }
        }

        // Smart vacation days function - handles single or range
        function addVacationDays() {
            const startInput = document.getElementById('vacation-start-date');
            const endInput = document.getElementById('vacation-end-date');
            const startDate = startInput.value;
            const endDate = endInput.value;

            // At least start date required
            if (!startDate) {
                alert('Please select a date');
                return;
            }

            const start = new Date(startDate);
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            if (start < today) {
                alert('Cannot add past dates');
                return;
            }

            // If no end date or same as start, add single day
            if (!endDate || endDate === startDate) {
                if (vacationDays.includes(startDate)) {
                    alert('This date is already added');
                    return;
                }
                vacationDays.push(startDate);
            } else {
                // Add range
                const end = new Date(endDate);

                if (end < start) {
                    alert('End date must be after start date');
                    return;
                }

                // Limit range to 60 days
                const daysDiff = Math.ceil((end - start) / (1000 * 60 * 60 * 24));
                if (daysDiff > 60) {
                    alert('Date range cannot exceed 60 days');
                    return;
                }

                let addedCount = 0;
                const current = new Date(start);
                while (current <= end) {
                    const dateStr = current.toISOString().split('T')[0];
                    if (!vacationDays.includes(dateStr)) {
                        vacationDays.push(dateStr);
                        addedCount++;
                    }
                    current.setDate(current.getDate() + 1);
                }

                if (addedCount === 0) {
                    alert('All dates in this range are already added');
                    return;
                }
            }

            vacationDays.sort();
            renderVacationDays();
            updatePickupPreview();
            autoSaveSettings();

            // Clear inputs and reset button
            startInput.value = '';
            endInput.value = '';
            updateVacationButtonText();
        }

        // Legacy functions for backwards compatibility
        function addVacationDay() { addVacationDays(); }
        function addSingleVacationDay() { addVacationDays(); }
        function addVacationRange() { addVacationDays(); }

        // Remove vacation day
        function removeVacationDay(date) {
            vacationDays = vacationDays.filter(d => d !== date);
            renderVacationDays();
            updatePickupPreview();
        }

        // Render vacation days list
        function renderVacationDays() {
            const container = document.getElementById('vacation-days-list');
            container.innerHTML = vacationDays.map(date => {
                const formatted = new Date(date + 'T00:00:00').toLocaleDateString('en-US', {
                    weekday: 'short', month: 'short', day: 'numeric'
                });
                return `
                    <span style="display: inline-flex; align-items: center; gap: 6px; padding: 6px 10px; background: #ffd79d; border-radius: 4px; font-size: 13px;">
                        ${formatted}
                        <button type="button" onclick="removeVacationDay('${date}')" style="background: none; border: none; cursor: pointer; color: #666; font-size: 16px; padding: 0;">&times;</button>
                    </span>
                `;
            }).join('');
        }

        // Calculate pickup date (client-side preview)
        function calculatePickupDatePreview() {
            const dayNames = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
            const processingDays = parseInt(document.getElementById('processing-days').value) || 1;
            const fulfillmentDays = Array.from(document.querySelectorAll('.fulfillment-day:checked')).map(cb => cb.value);
            const vacationSet = new Set(vacationDays);

            if (fulfillmentDays.length === 0) {
                return null;
            }

            const fulfillmentSet = new Set(fulfillmentDays);

            function isFulfillmentDay(date) {
                const dayName = dayNames[date.getDay()];
                const dateStr = date.toISOString().split('T')[0];
                return fulfillmentSet.has(dayName) && !vacationSet.has(dateStr);
            }

            let currentDate = new Date();
            currentDate.setHours(0, 0, 0, 0);

            let daysProcessed = 0;
            while (daysProcessed < processingDays) {
                currentDate.setDate(currentDate.getDate() + 1);
                if (isFulfillmentDay(currentDate)) {
                    daysProcessed++;
                }
            }

            while (!isFulfillmentDay(currentDate)) {
                currentDate.setDate(currentDate.getDate() + 1);
            }

            // Pickup day is day after dropoff
            const pickupDate = new Date(currentDate);
            pickupDate.setDate(pickupDate.getDate() + 1);

            return pickupDate;
        }

        // Format pickup date for preview
        function formatPickupDatePreview(pickupDate) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);

            const pickup = new Date(pickupDate);
            pickup.setHours(0, 0, 0, 0);

            if (pickup.getTime() === tomorrow.getTime()) {
                return 'Tomorrow';
            } else {
                const options = { weekday: 'long', month: 'short', day: 'numeric' };
                return pickup.toLocaleDateString('en-US', options);
            }
        }

        // Update pickup preview
        function updatePickupPreview() {
            const previewText = document.getElementById('pickup-preview-text');
            const pickupDate = calculatePickupDatePreview();

            if (!pickupDate) {
                previewText.innerHTML = '<span style="color: #bf0711;">Please select at least one fulfillment day</span>';
                return;
            }

            const formatted = formatPickupDatePreview(pickupDate);
            previewText.innerHTML = `Based on current settings, customers ordering today will see pickup available <strong>${formatted}</strong>`;
        }

        // Update pricing display based on free pickup toggle
        function updatePricingDisplay(freePickup) {
            const infoEl = document.getElementById('pricing-display');

            if (freePickup) {
                infoEl.innerHTML = `
                    <strong>Customer pays:</strong> <span id="customer-price" style="color: #008060;">$0.00</span> at checkout<br>
                    <small style="color: #6d7175;">You absorb the locker pickup fee</small>
                `;
            } else {
                infoEl.innerHTML = `
                    <strong>Customer pays:</strong> <span id="customer-price">Locker fee</span> at checkout<br>
                    <small style="color: #6d7175;">Fee varies by locker size selected</small>
                `;
            }
        }

        // Update last refresh timestamp
        function updateRefreshTime() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString();
            const el = document.getElementById('last-refresh');
            if (el) el.textContent = timeStr;
        }

        // Validate Shopify token on load
        async function validateToken() {
            try {
                const response = await fetch(`/api/validate-token/${shop}`);
                const result = await response.json();

                if (!result.valid) {
                    console.warn('Shopify token invalid:', result.error);
                    document.getElementById('reconnect-banner').style.display = 'block';
                    if (result.error) {
                        document.getElementById('reconnect-message').textContent =
                            `‚ö†Ô∏è Shopify connection error: ${result.error}. Click to reconnect.`;
                    }
                    return false;
                }
                return true;
            } catch (error) {
                console.error('Error validating token:', error);
                return false;
            }
        }

        // Reconnect to Shopify
        function reconnectToShopify() {
            window.location.href = `/auth/reconnect?shop=${shop}`;
        }

        // Check Shopify scopes for fulfillment permissions
        async function checkScopes() {
            // Skip if user dismissed the warning this session
            if (sessionStorage.getItem('scopeWarningDismissed')) {
                return;
            }

            try {
                const response = await fetch(`/api/check-scopes/${shop}`);
                const result = await response.json();

                if (result.needsReauth && result.missingScopes && result.missingScopes.length > 0) {
                    console.warn('Missing Shopify scopes:', result.missingScopes);
                    document.getElementById('scope-warning-banner').style.display = 'block';
                    document.getElementById('scope-warning-message').textContent =
                        `Auto-fulfillment is disabled. Missing permission: ${result.missingScopes.join(', ')}. Orders will not auto-fulfill when customers pick up.`;
                }
            } catch (error) {
                console.error('Error checking scopes:', error);
            }
        }

        // Dismiss scope warning for this session
        function dismissScopeWarning() {
            document.getElementById('scope-warning-banner').style.display = 'none';
            sessionStorage.setItem('scopeWarningDismissed', 'true');
        }

        // Initialize
        window.onload = async function() {
            // Validate token first
            await validateToken();

            // Check scopes for fulfillment permissions
            checkScopes();

            loadStats();
            loadOrders();
            loadSubscription();
            loadSettings();
            updateRefreshTime();

            // Add event listener for free pickup checkbox
            const freePickupCheckbox = document.getElementById('free-pickup');
            if (freePickupCheckbox) {
                freePickupCheckbox.addEventListener('change', function() {
                    updatePricingDisplay(this.checked);
                });
            }

            // Add event listeners for fulfillment settings to update preview
            document.getElementById('processing-days').addEventListener('change', updatePickupPreview);
            document.querySelectorAll('.fulfillment-day').forEach(cb => {
                cb.addEventListener('change', updatePickupPreview);
            });

            // Auto-refresh orders every 30 seconds
            setInterval(() => {
                loadOrders();
                loadStats();
                updateRefreshTime();
            }, 30000);
        };

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('orderModal');
            const manualModal = document.getElementById('manualOrderModal');
            if (event.target == modal) {
                modal.style.display = 'none';
            }
            if (event.target == manualModal) {
                manualModal.style.display = 'none';
            }
        };

        // Manual Order Functions
        async function openManualOrderModal() {
            const modal = document.getElementById('manualOrderModal');
            const select = document.getElementById('manual-locker-select');

            // Clear form
            document.getElementById('manualOrderForm').reset();

            // Load locker options
            select.innerHTML = '<option value="">Loading lockers...</option>';

            try {
                const response = await fetch(`/api/locker-preferences/${shop}`);
                const preferences = await response.json();

                if (preferences.length === 0) {
                    select.innerHTML = '<option value="">No lockers configured - go to My Lockers tab</option>';
                } else {
                    select.innerHTML = '<option value="">Select a locker...</option>' +
                        preferences.map(p => `<option value="${p.location_id}" data-name="${p.location_name}">${p.location_name}</option>`).join('');
                }
            } catch (error) {
                console.error('Error loading lockers:', error);
                select.innerHTML = '<option value="">Error loading lockers</option>';
            }

            modal.style.display = 'block';
        }

        function closeManualOrderModal() {
            document.getElementById('manualOrderModal').style.display = 'none';
        }

        async function submitManualOrder(event) {
            event.preventDefault();

            const orderNumber = document.getElementById('manual-order-number').value.trim();
            const customerName = document.getElementById('manual-customer-name').value.trim();
            const customerEmail = document.getElementById('manual-customer-email').value.trim();
            const lockerSelect = document.getElementById('manual-locker-select');
            const lockerId = lockerSelect.value;
            const lockerName = lockerSelect.options[lockerSelect.selectedIndex].dataset.name;
            const sendEmail = document.getElementById('manual-send-email').checked;

            if (!orderNumber || !customerName || !customerEmail || !lockerId) {
                alert('Please fill in all required fields');
                return;
            }

            try {
                const response = await fetch(`/api/manual-order/${shop}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        orderNumber,
                        customerName,
                        customerEmail,
                        lockerId,
                        lockerName,
                        sendEmail
                    })
                });

                const result = await response.json();

                if (result.success) {
                    alert('Manual order created successfully!');
                    closeManualOrderModal();
                    loadOrders();
                    loadStats();
                } else {
                    alert('Failed to create order: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error creating manual order:', error);
                alert('Error creating order: ' + error.message);
            }
        }

        // Product Size Functions
        let productsData = [];

        async function loadProducts() {
            const container = document.getElementById('products-list');
            container.innerHTML = '<p>Loading products from Shopify...</p>';

            try {
                const response = await fetch(`/api/products/${shop}`);
                const data = await response.json();

                if (!response.ok) {
                    if (data.needsReauth) {
                        container.innerHTML = `
                            <div style="text-align: center; padding: 40px;">
                                <p style="color: #bf0711; margin-bottom: 16px;">Access token expired or revoked.</p>
                                <p style="color: #6d7175; margin-bottom: 20px;">Please reinstall the LockerDrop app from Shopify to reconnect.</p>
                                <a href="/auth/install?shop=${shop}" class="btn btn-primary">Reconnect App</a>
                            </div>
                        `;
                    } else {
                        throw new Error(data.error || 'Failed to load products');
                    }
                    return;
                }

                productsData = data.products || [];

                if (productsData.length === 0) {
                    container.innerHTML = '<p style="color: #6d7175;">No products found in your store.</p>';
                    return;
                }

                renderProducts();
            } catch (error) {
                console.error('Error loading products:', error);
                container.innerHTML = `<p style="color: #bf0711;">Error loading products: ${error.message}</p>`;
            }
        }

        function renderProducts() {
            const container = document.getElementById('products-list');

            const html = productsData.map(product => {
                const hasVariants = product.variants.length > 1;

                return `
                    <div class="product-item" style="border: 1px solid #e1e3e5; border-radius: 8px; padding: 16px; margin-bottom: 16px;">
                        <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 12px;">
                            ${product.image ? `<img src="${product.image}" alt="${product.title}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px;">` : '<div style="width: 50px; height: 50px; background: #f6f6f7; border-radius: 4px;"></div>'}
                            <div style="flex: 1;">
                                <strong style="font-size: 16px;">${product.title}</strong>
                                ${hasVariants ? `<span style="color: #6d7175; font-size: 12px; margin-left: 8px;">(${product.variants.length} variants)</span>` : ''}
                            </div>
                        </div>
                        ${product.variants.map(variant => renderVariantRow(product, variant, hasVariants)).join('')}
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
        }

        function renderVariantRow(product, variant, showVariantTitle) {
            const lockerSizes = ['small', 'medium', 'large', 'x-large'];
            const dataKey = `${product.id}-${variant.id}`;

            return `
                <div class="variant-row" style="display: grid; grid-template-columns: 1fr repeat(3, 70px) 120px; gap: 12px; align-items: center; padding: 8px 0; border-top: 1px solid #f0f0f0;" data-product-id="${product.id}" data-variant-id="${variant.id}" data-product-title="${product.title}" data-variant-title="${variant.title}">
                    <div>
                        ${showVariantTitle ? `<span style="color: #6d7175; font-size: 14px;">${variant.title}</span>` : '<span style="color: #6d7175; font-size: 14px;">Default</span>'}
                        ${variant.sku ? `<span style="color: #999; font-size: 12px; margin-left: 8px;">SKU: ${variant.sku}</span>` : ''}
                    </div>
                    <div>
                        <input type="number" step="0.1" min="0" placeholder="L" class="dim-input dim-length"
                               value="${variant.length_inches || ''}"
                               style="width: 60px; padding: 6px; border: 1px solid #c4cdd5; border-radius: 4px; text-align: center;">
                    </div>
                    <div>
                        <input type="number" step="0.1" min="0" placeholder="W" class="dim-input dim-width"
                               value="${variant.width_inches || ''}"
                               style="width: 60px; padding: 6px; border: 1px solid #c4cdd5; border-radius: 4px; text-align: center;">
                    </div>
                    <div>
                        <input type="number" step="0.1" min="0" placeholder="H" class="dim-input dim-height"
                               value="${variant.height_inches || ''}"
                               style="width: 60px; padding: 6px; border: 1px solid #c4cdd5; border-radius: 4px; text-align: center;">
                    </div>
                    <div>
                        <select class="size-select" style="width: 110px; padding: 6px; border: 1px solid #c4cdd5; border-radius: 4px;">
                            <option value="">Auto</option>
                            ${lockerSizes.map(size => `<option value="${size}" ${variant.locker_size === size ? 'selected' : ''}>${size.charAt(0).toUpperCase() + size.slice(1)}</option>`).join('')}
                        </select>
                    </div>
                </div>
            `;
        }

        async function saveProductSizes() {
            const rows = document.querySelectorAll('.variant-row');
            const products = [];

            rows.forEach(row => {
                const productId = row.dataset.productId;
                const variantId = row.dataset.variantId;
                const productTitle = row.dataset.productTitle;
                const variantTitle = row.dataset.variantTitle;

                const length = parseFloat(row.querySelector('.dim-length').value) || 0;
                const width = parseFloat(row.querySelector('.dim-width').value) || 0;
                const height = parseFloat(row.querySelector('.dim-height').value) || 0;
                const lockerSize = row.querySelector('.size-select').value;

                // Only save if something was entered
                if (length > 0 || width > 0 || height > 0 || lockerSize) {
                    products.push({
                        product_id: productId,
                        variant_id: variantId,
                        product_title: productTitle,
                        variant_title: variantTitle,
                        length,
                        width,
                        height,
                        locker_size: lockerSize || 'medium'
                    });
                }
            });

            if (products.length === 0) {
                alert('No product sizes to save. Enter dimensions or select a locker size for at least one product.');
                return;
            }

            // Check for products without sizes and warn user
            const totalProducts = rows.length;
            const unconfiguredCount = totalProducts - products.length;
            if (unconfiguredCount > 0) {
                const proceed = confirm(
                    `‚ö†Ô∏è ${unconfiguredCount} product${unconfiguredCount !== 1 ? 's' : ''} still ${unconfiguredCount !== 1 ? 'have' : 'has'} no size configured.\n\n` +
                    `Products without sizes will use "Medium" as the default locker size.\n\n` +
                    `Continue saving ${products.length} configured product${products.length !== 1 ? 's' : ''}?`
                );
                if (!proceed) return;
            }

            const btn = document.getElementById('save-products-btn');
            const originalText = btn.textContent;
            btn.classList.add('btn-loading');
            btn.textContent = 'Saving...';

            try {
                const response = await fetch(`/api/product-sizes/${shop}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ products })
                });

                const result = await response.json();

                if (result.success) {
                    btn.textContent = `‚úì ${products.length} product${products.length !== 1 ? 's' : ''} updated`;
                    btn.style.background = '#008060';
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.style.background = '';
                    }, 2500);
                } else {
                    alert('Failed to save: ' + (result.error || 'Unknown error'));
                    btn.textContent = originalText;
                }
            } catch (error) {
                console.error('Error saving product sizes:', error);
                alert('Error saving: ' + error.message);
                btn.textContent = originalText;
            } finally {
                btn.classList.remove('btn-loading');
            }
        }

        // ============================================
        // BILLING & SUBSCRIPTION FUNCTIONS
        // ============================================

        let currentSubscription = null;

        async function loadSubscription() {
            try {
                const response = await fetch(`/api/subscription/${shop}`);
                const data = await response.json();
                currentSubscription = data;
                renderSubscriptionStatus(data);
                renderUsageMeter(data);
                updatePlanButtons(data);
                updateBrandingTabVisibility(data.features);
                checkDevMode();
                handleBillingUrlParams();
            } catch (error) {
                console.error('Error loading subscription:', error);
                document.getElementById('subscription-status').innerHTML = `
                    <p style="color: #bf0711;">Error loading subscription status</p>
                `;
            }
        }

        function renderSubscriptionStatus(sub) {
            const statusEl = document.getElementById('subscription-status');
            let statusBadge = '';
            let statusMessage = '';

            if (sub.status === 'trial') {
                statusBadge = '<span style="background: #fff4e6; color: #996300; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 500;">Trial</span>';
                if (sub.trialDaysLeft > 0) {
                    statusMessage = `Your free trial ends in <strong>${sub.trialDaysLeft} day${sub.trialDaysLeft !== 1 ? 's' : ''}</strong>. Subscribe to a plan to continue using LockerDrop.`;
                } else {
                    statusMessage = '<span style="color: #bf0711;">Your trial has expired.</span> Please subscribe to continue using LockerDrop.';
                }
            } else if (sub.status === 'active') {
                statusBadge = '<span style="background: #e3f5ef; color: #008060; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 500;">Active</span>';
                statusMessage = `You're on the <strong>${sub.planName}</strong> plan ($${sub.price}/month).`;
                document.getElementById('cancel-card').style.display = 'block';
            } else if (sub.status === 'cancelled') {
                statusBadge = '<span style="background: #f0f1f2; color: #6d7175; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 500;">Cancelled</span>';
                statusMessage = 'Your subscription has been cancelled. Subscribe to a plan to continue using LockerDrop.';
            }

            statusEl.innerHTML = `
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                    <span style="font-size: 18px; font-weight: 600;">${sub.planName} Plan</span>
                    ${statusBadge}
                </div>
                <p style="color: #6d7175;">${statusMessage}</p>
            `;
        }

        function renderUsageMeter(sub) {
            const usageCard = document.getElementById('usage-card');
            const usageCount = document.getElementById('usage-count');
            const usageBar = document.getElementById('usage-bar');
            const usageMessage = document.getElementById('usage-message');

            if (sub.orderLimit === 'unlimited' || sub.orderLimit === -1) {
                usageCard.style.display = 'block';
                usageCount.textContent = `${sub.ordersUsed} orders used`;
                usageBar.style.width = '0%';
                usageMessage.textContent = 'Unlimited orders on your plan.';
            } else {
                usageCard.style.display = 'block';
                const percent = Math.min(100, (sub.ordersUsed / sub.orderLimit) * 100);
                usageCount.textContent = `${sub.ordersUsed} / ${sub.orderLimit}`;
                usageBar.style.width = `${percent}%`;

                // Change color based on usage
                if (percent >= 90) {
                    usageBar.style.background = '#bf0711';
                    usageMessage.innerHTML = '<span style="color: #bf0711;">You\'re almost at your monthly limit! Consider upgrading your plan.</span>';
                } else if (percent >= 75) {
                    usageBar.style.background = '#996300';
                    usageMessage.textContent = 'You\'ve used most of your monthly allowance.';
                } else {
                    usageBar.style.background = '#5c6ac4';
                    usageMessage.textContent = `${sub.ordersRemaining} orders remaining this billing cycle.`;
                }
            }
        }

        function updatePlanButtons(sub) {
            const planCards = document.querySelectorAll('.plan-card');

            planCards.forEach(card => {
                const planId = card.dataset.plan;
                const btn = card.querySelector('.plan-btn');

                if (sub.plan === planId && sub.status === 'active') {
                    btn.textContent = 'Current Plan';
                    btn.disabled = true;
                    btn.classList.remove('btn-primary', 'btn-secondary');
                    btn.style.background = '#e1e3e5';
                    btn.style.cursor = 'default';
                    card.style.borderColor = '#008060';
                } else {
                    btn.disabled = false;
                    btn.style.cursor = 'pointer';
                }
            });
        }

        async function subscribeToPlan(planId) {
            if (!confirm(`Subscribe to the ${planId.charAt(0).toUpperCase() + planId.slice(1)} plan?`)) {
                return;
            }

            try {
                const response = await fetch(`/api/subscribe/${shop}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ planId })
                });

                const result = await response.json();

                if (result.confirmationUrl) {
                    // Redirect to Shopify's payment page
                    window.top.location.href = result.confirmationUrl;
                } else {
                    alert('Error: ' + (result.error || 'Could not create subscription'));
                }
            } catch (error) {
                console.error('Error subscribing:', error);
                alert('Error creating subscription: ' + error.message);
            }
        }

        async function cancelSubscription() {
            if (!confirm('Are you sure you want to cancel your subscription? You will lose access to LockerDrop features at the end of your billing period.')) {
                return;
            }

            try {
                const response = await fetch(`/api/subscription/cancel/${shop}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const result = await response.json();

                if (result.success) {
                    alert('Subscription cancelled successfully.');
                    loadSubscription();
                } else {
                    alert('Error: ' + (result.error || 'Could not cancel subscription'));
                }
            } catch (error) {
                console.error('Error cancelling:', error);
                alert('Error cancelling subscription: ' + error.message);
            }
        }

        function handleBillingUrlParams() {
            const billing = urlParams.get('billing');
            const plan = urlParams.get('plan');

            if (billing === 'success') {
                alert(`Successfully subscribed to the ${plan ? plan.charAt(0).toUpperCase() + plan.slice(1) : ''} plan!`);
                // Clean up URL
                window.history.replaceState({}, document.title, window.location.pathname + '?shop=' + shop);
                // Reload subscription
                loadSubscription();
            } else if (billing === 'cancelled') {
                alert('Subscription was not completed. You can subscribe anytime from the Billing tab.');
                window.history.replaceState({}, document.title, window.location.pathname + '?shop=' + shop);
            } else if (billing === 'error') {
                alert('There was an error processing your subscription. Please try again.');
                window.history.replaceState({}, document.title, window.location.pathname + '?shop=' + shop);
            }
        }

        // Dev Mode Functions
        const DEV_STORES = ['enna-test.myshopify.com'];

        function checkDevMode() {
            if (DEV_STORES.includes(shop)) {
                const devCard = document.getElementById('dev-mode-card');
                if (devCard) devCard.style.display = 'block';
            }
        }

        async function devSwitchPlan(planId) {
            if (!DEV_STORES.includes(shop)) {
                alert('Dev mode not available for this store');
                return;
            }

            try {
                const response = await fetch(`/api/subscription/dev-switch/${shop}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ planId })
                });

                const result = await response.json();

                if (result.success) {
                    alert(`Switched to ${planId.charAt(0).toUpperCase() + planId.slice(1)} plan!`);
                    loadSubscription(); // Refresh subscription status
                } else {
                    alert('Error: ' + (result.error || 'Could not switch plan'));
                }
            } catch (error) {
                console.error('Error switching plan:', error);
                alert('Error switching plan: ' + error.message);
            }
        }

        // ============================================
        // BRANDING FUNCTIONS (Enterprise Only)
        // ============================================

        async function loadBrandingSettings() {
            try {
                // Set preview link
                const previewLink = document.getElementById('branding-preview-link');
                if (previewLink) {
                    previewLink.href = `/pickup-success?order=PREVIEW&status=success&shop=${shop}`;
                }

                const response = await fetch(`/api/branding/${shop}`);
                const data = await response.json();

                if (!data.enabled) {
                    // Hide branding tab for non-enterprise users
                    return;
                }

                // Populate form fields
                document.getElementById('branding-logo').value = data.logoUrl || '';

                // Show logo preview if exists
                if (data.logoUrl) {
                    document.getElementById('logo-preview').src = data.logoUrl;
                    document.getElementById('logo-preview-container').style.display = 'block';
                    document.getElementById('logo-upload-container').style.display = 'none';
                } else {
                    document.getElementById('logo-preview-container').style.display = 'none';
                    document.getElementById('logo-upload-container').style.display = 'block';
                }

                document.getElementById('branding-primary-color').value = data.primaryColor || '#5c6ac4';
                document.getElementById('branding-primary-color-text').value = data.primaryColor || '#5c6ac4';
                document.getElementById('branding-secondary-color').value = data.secondaryColor || '#202223';
                document.getElementById('branding-secondary-color-text').value = data.secondaryColor || '#202223';
                document.getElementById('branding-success-message').value = data.successMessage || '';
                document.getElementById('branding-show-upsells').checked = data.showUpsells !== false;
                document.getElementById('branding-upsell-heading').value = data.upsellHeading || 'You might also like';
                document.getElementById('branding-rebuy-enabled').checked = data.rebuyEnabled || false;

                // Load upsell products with full details
                const savedProductIds = data.upsellProductIds || [];
                if (savedProductIds.length > 0 && allProducts.length > 0) {
                    // Match saved IDs with product details
                    selectedUpsellProducts = savedProductIds.map(id => {
                        const product = allProducts.find(p => p.id === id || p.id === String(id));
                        return product ? { id: product.id, title: product.title, image: product.image } : { id, title: `Product ${id}`, image: '' };
                    }).filter(p => p);
                } else if (savedProductIds.length > 0) {
                    // Products not loaded yet, store IDs and try again later
                    selectedUpsellProducts = savedProductIds.map(id => ({ id, title: `Product ${id}`, image: '' }));
                    // Retry after products load
                    setTimeout(async () => {
                        if (allProducts.length === 0) {
                            await loadProductsForPicker();
                        }
                        selectedUpsellProducts = savedProductIds.map(id => {
                            const product = allProducts.find(p => p.id === id || p.id === String(id));
                            return product ? { id: product.id, title: product.title, image: product.image } : { id, title: `Product ${id}`, image: '' };
                        }).filter(p => p);
                        renderSelectedUpsellProducts();
                        updateUpsellProductsHiddenField();
                    }, 1000);
                } else {
                    selectedUpsellProducts = [];
                }
                renderSelectedUpsellProducts();
                updateUpsellProductsHiddenField();
                document.getElementById('branding-rebuy-widget-id').value = data.rebuyWidgetId || '';
                document.getElementById('branding-custom-css').value = data.customCss || '';

                // Toggle Rebuy settings visibility
                document.getElementById('rebuy-settings').style.display = data.rebuyEnabled ? 'block' : 'none';

            } catch (error) {
                console.error('Error loading branding settings:', error);
            }
        }

        // Handle logo file selection and upload
        async function handleLogoSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Validate file size
            if (file.size > 2 * 1024 * 1024) {
                alert('File is too large. Maximum size is 2MB.');
                event.target.value = '';
                return;
            }

            // Show loading state
            const uploadBtn = document.querySelector('#logo-upload-container button');
            const originalText = uploadBtn.innerHTML;
            uploadBtn.innerHTML = '‚è≥ Uploading...';
            uploadBtn.disabled = true;

            try {
                const formData = new FormData();
                formData.append('logo', file);

                const response = await fetch(`/api/branding/${shop}/logo`, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    // Update hidden field with URL
                    document.getElementById('branding-logo').value = result.logoUrl;

                    // Show preview
                    document.getElementById('logo-preview').src = result.logoUrl;
                    document.getElementById('logo-preview-container').style.display = 'block';
                    document.getElementById('logo-upload-container').style.display = 'none';

                    // Auto-save branding settings
                    autoSaveBranding();
                } else {
                    alert('Error uploading logo: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error uploading logo:', error);
                alert('Error uploading logo. Please try again.');
            } finally {
                uploadBtn.innerHTML = originalText;
                uploadBtn.disabled = false;
                event.target.value = ''; // Reset file input
            }
        }

        // Remove logo
        async function removeLogo() {
            if (!confirm('Remove your logo?')) return;

            try {
                const response = await fetch(`/api/branding/${shop}/logo`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    document.getElementById('branding-logo').value = '';
                    document.getElementById('logo-preview').src = '';
                    document.getElementById('logo-preview-container').style.display = 'none';
                    document.getElementById('logo-upload-container').style.display = 'block';

                    // Auto-save branding settings
                    autoSaveBranding();
                } else {
                    alert('Error removing logo: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error removing logo:', error);
                alert('Error removing logo. Please try again.');
            }
        }

        // ============================================
        // UPSELL PRODUCT PICKER
        // ============================================

        // Store selected upsell products with full details
        let selectedUpsellProducts = [];
        let allProducts = []; // Cache for all products
        let productSearchTimeout = null;

        // Search products for upsell picker
        async function searchUpsellProducts(query) {
            clearTimeout(productSearchTimeout);
            const dropdown = document.getElementById('upsell-product-dropdown');

            if (!query || query.length < 2) {
                // Show all products if query is empty or short
                productSearchTimeout = setTimeout(() => renderProductDropdown(allProducts, query), 200);
                return;
            }

            productSearchTimeout = setTimeout(async () => {
                // Filter from cached products
                const filtered = allProducts.filter(p =>
                    p.title.toLowerCase().includes(query.toLowerCase())
                );
                renderProductDropdown(filtered, query);
            }, 200);
        }

        // Load all products for the picker
        async function loadProductsForPicker() {
            try {
                const response = await fetch(`/api/products/${shop}`);
                const data = await response.json();
                allProducts = data.products || [];
            } catch (error) {
                console.error('Error loading products for picker:', error);
                allProducts = [];
            }
        }

        // Show product dropdown
        function showProductDropdown() {
            const dropdown = document.getElementById('upsell-product-dropdown');
            if (selectedUpsellProducts.length >= 4) {
                dropdown.innerHTML = '<div style="padding: 12px; color: #6d7175; text-align: center;">Maximum 4 products reached</div>';
                dropdown.style.display = 'block';
                return;
            }
            renderProductDropdown(allProducts, '');
            dropdown.style.display = 'block';
        }

        // Hide product dropdown
        function hideProductDropdown() {
            setTimeout(() => {
                document.getElementById('upsell-product-dropdown').style.display = 'none';
            }, 200);
        }

        // Render product dropdown
        function renderProductDropdown(products, query) {
            const dropdown = document.getElementById('upsell-product-dropdown');

            if (selectedUpsellProducts.length >= 4) {
                dropdown.innerHTML = '<div style="padding: 12px; color: #6d7175; text-align: center;">Maximum 4 products reached</div>';
                dropdown.style.display = 'block';
                return;
            }

            // Filter out already selected products
            const selectedIds = selectedUpsellProducts.map(p => p.id);
            const available = products.filter(p => !selectedIds.includes(p.id));

            if (available.length === 0) {
                dropdown.innerHTML = '<div style="padding: 12px; color: #6d7175; text-align: center;">' +
                    (query ? 'No matching products found' : 'No more products available') + '</div>';
                dropdown.style.display = 'block';
                return;
            }

            dropdown.innerHTML = available.slice(0, 10).map(product => `
                <div onclick="addUpsellProduct('${product.id}', '${product.title.replace(/'/g, "\\'")}', '${product.image || ''}')"
                     style="display: flex; align-items: center; gap: 12px; padding: 10px 12px; cursor: pointer; border-bottom: 1px solid #f0f0f0; transition: background 0.15s;"
                     onmouseover="this.style.background='#f6f6f7'" onmouseout="this.style.background='white'">
                    <img src="${product.image || 'https://cdn.shopify.com/s/files/1/0533/2089/files/placeholder-images-image_large.png'}"
                         alt="" style="width: 40px; height: 40px; object-fit: cover; border-radius: 4px; background: #f6f6f7;">
                    <div style="flex: 1; min-width: 0;">
                        <div style="font-weight: 500; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${product.title}</div>
                        ${product.price ? `<div style="font-size: 12px; color: #6d7175;">$${product.price}</div>` : ''}
                    </div>
                </div>
            `).join('');

            dropdown.style.display = 'block';
        }

        // Add product to upsell list
        function addUpsellProduct(id, title, image) {
            if (selectedUpsellProducts.length >= 4) {
                alert('Maximum 4 products allowed');
                return;
            }

            if (selectedUpsellProducts.find(p => p.id === id)) {
                return; // Already selected
            }

            selectedUpsellProducts.push({ id, title, image });
            renderSelectedUpsellProducts();
            updateUpsellProductsHiddenField();

            // Clear search and hide dropdown
            document.getElementById('upsell-product-search').value = '';
            document.getElementById('upsell-product-dropdown').style.display = 'none';
        }

        // Remove product from upsell list
        function removeUpsellProduct(id) {
            selectedUpsellProducts = selectedUpsellProducts.filter(p => p.id !== id);
            renderSelectedUpsellProducts();
            updateUpsellProductsHiddenField();
        }

        // Render selected products
        function renderSelectedUpsellProducts() {
            const container = document.getElementById('selected-upsell-products');

            if (selectedUpsellProducts.length === 0) {
                container.innerHTML = '<div style="padding: 12px; background: #f6f6f7; border-radius: 6px; color: #6d7175; text-align: center; font-size: 13px;">No products selected. Search below to add upsell products.</div>';
                return;
            }

            container.innerHTML = selectedUpsellProducts.map((product, index) => `
                <div style="display: flex; align-items: center; gap: 12px; padding: 10px 12px; background: #f6f6f7; border-radius: 6px;">
                    <span style="color: #6d7175; font-size: 12px; font-weight: 500;">${index + 1}</span>
                    <img src="${product.image || 'https://cdn.shopify.com/s/files/1/0533/2089/files/placeholder-images-image_large.png'}"
                         alt="" style="width: 40px; height: 40px; object-fit: cover; border-radius: 4px; background: white;">
                    <div style="flex: 1; min-width: 0;">
                        <div style="font-weight: 500; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${product.title}</div>
                    </div>
                    <button type="button" onclick="removeUpsellProduct('${product.id}')"
                            style="background: none; border: none; color: #bf0711; cursor: pointer; padding: 4px 8px; font-size: 18px; line-height: 1;"
                            title="Remove product">&times;</button>
                </div>
            `).join('');
        }

        // Update hidden field with product IDs
        function updateUpsellProductsHiddenField() {
            const ids = selectedUpsellProducts.map(p => p.id);
            document.getElementById('branding-upsell-products').value = ids.join(', ');
        }

        // Initialize product picker on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Load products for the picker
            loadProductsForPicker();

            // Close dropdown when clicking outside
            document.addEventListener('click', function(e) {
                const container = document.getElementById('upsell-product-search-container');
                if (container && !container.contains(e.target)) {
                    document.getElementById('upsell-product-dropdown').style.display = 'none';
                }
            });
        });

        // Auto-save branding debounce timer
        let autoSaveBrandingTimer = null;

        // Auto-save Branding (debounced)
        function autoSaveBranding() {
            if (autoSaveBrandingTimer) clearTimeout(autoSaveBrandingTimer);
            autoSaveBrandingTimer = setTimeout(async () => {
                await saveBrandingSettings();
            }, 500);
        }

        async function saveBrandingSettings() {
            const secondaryColorEl = document.getElementById('branding-secondary-color');
            const rebuyEnabledEl = document.getElementById('branding-rebuy-enabled');
            const rebuyWidgetIdEl = document.getElementById('branding-rebuy-widget-id');
            const customCssEl = document.getElementById('branding-custom-css');

            const settings = {
                logoUrl: document.getElementById('branding-logo').value || null,
                primaryColor: document.getElementById('branding-primary-color').value,
                secondaryColor: secondaryColorEl ? secondaryColorEl.value : null,
                successMessage: document.getElementById('branding-success-message').value || null,
                showUpsells: document.getElementById('branding-show-upsells').checked,
                upsellHeading: document.getElementById('branding-upsell-heading').value || null,
                upsellProductIds: document.getElementById('branding-upsell-products').value
                    .split(',')
                    .map(id => id.trim())
                    .filter(id => id),
                rebuyEnabled: rebuyEnabledEl ? rebuyEnabledEl.checked : false,
                rebuyWidgetId: rebuyWidgetIdEl ? rebuyWidgetIdEl.value : null,
                customCss: customCssEl ? customCssEl.value : null
            };

            try {
                const response = await fetch(`/api/branding/${shop}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settings)
                });

                const result = await response.json();

                if (result.success) {
                    // Show saved status banner
                    const statusEl = document.getElementById('settings-save-status');
                    if (statusEl) {
                        statusEl.style.display = 'block';
                        setTimeout(() => {
                            statusEl.style.display = 'none';
                        }, 3000);
                    }
                } else if (result.upgrade) {
                    alert('Custom branding requires the Enterprise plan. Please upgrade to access this feature.');
                } else {
                    alert('Error: ' + (result.error || 'Could not save settings'));
                }
            } catch (error) {
                console.error('Error saving branding:', error);
            }
        }

        // Color picker sync
        document.addEventListener('DOMContentLoaded', function() {
            // Primary color sync
            const primaryColor = document.getElementById('branding-primary-color');
            const primaryColorText = document.getElementById('branding-primary-color-text');
            if (primaryColor && primaryColorText) {
                primaryColor.addEventListener('input', () => primaryColorText.value = primaryColor.value);
                primaryColorText.addEventListener('input', () => {
                    if (/^#[0-9A-Fa-f]{6}$/.test(primaryColorText.value)) {
                        primaryColor.value = primaryColorText.value;
                    }
                });
            }

            // Secondary color sync
            const secondaryColor = document.getElementById('branding-secondary-color');
            const secondaryColorText = document.getElementById('branding-secondary-color-text');
            if (secondaryColor && secondaryColorText) {
                secondaryColor.addEventListener('input', () => secondaryColorText.value = secondaryColor.value);
                secondaryColorText.addEventListener('input', () => {
                    if (/^#[0-9A-Fa-f]{6}$/.test(secondaryColorText.value)) {
                        secondaryColor.value = secondaryColorText.value;
                    }
                });
            }

            // Rebuy toggle
            const rebuyEnabled = document.getElementById('branding-rebuy-enabled');
            const rebuySettings = document.getElementById('rebuy-settings');
            if (rebuyEnabled && rebuySettings) {
                rebuyEnabled.addEventListener('change', () => {
                    rebuySettings.style.display = rebuyEnabled.checked ? 'block' : 'none';
                });
            }
        });

        // Show/hide branding tab based on subscription
        function updateBrandingTabVisibility(features) {
            const brandingTab = document.getElementById('branding-tab');
            if (brandingTab && features?.customBranding) {
                brandingTab.style.display = 'inline-block';
            }
        }
    </script>

    <!-- Footer -->
    <footer style="text-align: center; padding: 20px; margin-top: 40px; border-top: 1px solid #e1e3e5; color: #6d7175; font-size: 13px;">
        <p>
            <a href="/docs/training" style="color: #6d7175; margin: 0 8px;">Training</a> |
            <a href="/docs/faq" style="color: #6d7175; margin: 0 8px;">FAQ</a> |
            <a href="/privacy" style="color: #6d7175; margin: 0 8px;">Privacy Policy</a> |
            <a href="mailto:support@lockerdrop.it" style="color: #6d7175; margin: 0 8px;">Support</a>
        </p>
        <p style="margin-top: 8px;">&copy; 2025 LockerDrop. All rights reserved.</p>
    </footer>
</body>
</html>
